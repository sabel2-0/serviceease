// Account Management Page Logic

// Load current user profile and fill form - DEFINE FIRST
async function loadProfile() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/pages/login.html';
            return;
        }

        console.log('Fetching admin profile...');
        const res = await fetch('/api/admin/profile', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Profile response status:', res.status);
        
        if (res.ok) {
            const user = await res.json();
            console.log('Profile data received:', user);
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
        } else {
            const error = await res.text();
            console.error('Failed to load profile:', error);
            showNotification('Failed to load profile data', 'error');
        }
    } catch (err) {
        console.error('Error loading profile:', err);
        showNotification('Error loading profile. Please refresh the page.', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - account-management.js loaded');
    
    // Load current user profile into the form
    loadProfile();

    // Profile form submit
    const profileForm = document.getElementById('profile-form');
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const formData = new FormData(profileForm);
            const data = {
                first_name: formData.get('firstName'),
                last_name: formData.get('lastName')
            };
            try {
                const res = await fetch('/api/admin/profile', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    showNotification('Profile updated successfully!', 'success');
                    loadProfile();
                } else {
                    const err = await res.json();
                    showNotification('Error updating profile: ' + (err.error || 'Unable to update profile'), 'error');
                }
            } catch (err) {
                showNotification('Error updating profile. Please try again.', 'error');
            }
        });
    }

    // Note: Request code button handler is now in the HTML inline script
    // because the button only becomes visible after captcha verification

    // Note: Resend button handler will be attached when verification section becomes visible

    // Verify code button: validate code via server then reveal password form
    const verifyBtn = document.getElementById('verify-code-btn');
    console.log('Looking for verify-code-btn on page load:', verifyBtn ? 'FOUND' : 'NOT FOUND');
    if (verifyBtn) {
        console.log('Verify button event listener attached');
        verifyBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            console.log('Verify button clicked!');
            const token = localStorage.getItem('token');
            const codeInput = document.getElementById('verification-only-input');
            const code = codeInput ? codeInput.value.trim() : '';
            console.log('Verification code entered:', code ? `${code.length} digits` : 'empty');
            
            if (!code || code.length !== 6) { 
                alert('Please enter a valid 6-digit verification code'); 
                return; 
            }
            
            try {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = 'Checking...';
                console.log('Sending verification request...');
                
                const res = await fetch('/api/admin/verify-password-code', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verificationCode: code })
                });
                
                console.log('Verification response status:', res.status);
                
                if (res.ok) {
                    console.log('Code verified successfully!');
                    // mark verified and reveal security form
                    window._verificationVerified = true;
                    // copy code into hidden input inside security form
                    let hidden = document.getElementById('verificationCode');
                    if (!hidden) {
                        hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.id = 'verificationCode';
                        hidden.name = 'verificationCode';
                        document.getElementById('security-form').appendChild(hidden);
                    }
                    hidden.value = code;

                    document.getElementById('verification-only').style.display = 'none';
                    const securityPanel = document.getElementById('security-panel');
                    if (securityPanel) {
                        securityPanel.style.display = 'block';
                        console.log('Password form now visible');
                    }
                    // enable update button
                    const updateBtn = document.getElementById('update-password-btn');
                    if (updateBtn) {
                        updateBtn.disabled = false;
                        console.log('Update password button enabled');
                    }
                } else {
                    const err = await res.json();
                    console.error('Verification failed:', err);
                    alert('Verification failed: ' + (err.error || 'Invalid or expired code'));
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = 'Verify';
                }
            } catch (e) {
                console.error('Error verifying code:', e);
                alert('Error verifying code: ' + e.message);
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = 'Verify';
            }
        });
    } else {
        console.warn('verify-code-btn element not found on page load - will need dynamic attachment');
    }

    // NOTE: Password toggle functionality is now in the HTML file using event delegation
    // This ensures it works regardless of when elements are shown/hidden


    // Security form submit (password change)
    const securityForm = document.getElementById('security-form');
    console.log('Security form element found:', !!securityForm);
    if (securityForm) {
        console.log('⚠️ ATTACHING SUBMIT HANDLER TO SECURITY FORM');
        securityForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('=== PASSWORD UPDATE FORM SUBMITTED ===');
            console.log('Handler is ACTIVE and WORKING');
            
            // Ensure the verification code was verified first
            if (!window._verificationVerified) {
                console.log('❌ Verification not done');
                showNotification('Please request and verify the verification code first', 'warning');
                return;
            }
            
            const token = localStorage.getItem('token');
            const formData = new FormData(securityForm);
            const data = {
                currentPassword: formData.get('currentPassword'),
                newPassword: formData.get('newPassword'),
                confirmPassword: formData.get('confirmPassword'),
                verificationCode: formData.get('verificationCode')
            };
            
            console.log('Form data collected:', {
                currentPassword: data.currentPassword ? `${data.currentPassword.length} chars` : 'empty',
                newPassword: data.newPassword ? `${data.newPassword.length} chars` : 'empty',
                confirmPassword: data.confirmPassword ? `${data.confirmPassword.length} chars` : 'empty',
                verificationCode: data.verificationCode
            });
            
            // Check all required fields are filled
            if (!data.currentPassword || !data.newPassword || !data.confirmPassword) {
                console.log('❌ Missing required password fields');
                showNotification('Please fill in all password fields', 'error');
                return;
            }
            
            // Validation checks
            if (!data.verificationCode || data.verificationCode.length !== 6) {
                console.log('❌ Invalid verification code');
                showNotification('Please enter a valid 6-digit verification code', 'warning');
                return;
            }
            
            if (data.newPassword !== data.confirmPassword) {
                console.log('❌ Passwords do not match!');
                console.log('New:', data.newPassword);
                console.log('Confirm:', data.confirmPassword);
                showNotification('New passwords do not match!', 'error');
                return;
            }
            
            if (data.newPassword.length < 6) {
                console.log('❌ Password too short:', data.newPassword.length);
                showNotification('New password must be at least 6 characters long!', 'warning');
                return;
            }
            
            console.log('✓ All validations passed, sending to server...');
            
            try {
                const res = await fetch('/api/admin/password', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Server response status:', res.status);
                
                if (res.ok) {
                    console.log('✓ Password updated successfully');
                    showNotification('Password updated successfully! A confirmation email has been sent.', 'success');
                    securityForm.reset();
                    try { if (window.loadCaptchaSecurity) window.loadCaptchaSecurity(); } catch (e) { /* ignore */ }
                    // Hide verification-only UI and reset verification state
                    const verOnly = document.getElementById('verification-only');
                    if (verOnly) verOnly.style.display = 'none';
                    window._verificationVerified = false;
                    const hidden = document.getElementById('verificationCode');
                    if (hidden) { hidden.value = ''; }
                    document.getElementById('update-password-btn').disabled = true;
                    document.getElementById('request-code-btn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Request Verification Code';
                } else {
                    const err = await res.json();
                    showNotification('Error updating password: ' + (err.error || 'Unable to update password'), 'error');
                    try { if (window.loadCaptchaSecurity) window.loadCaptchaSecurity(); } catch (e) { /* ignore */ }
                }
            } catch (err) {
                showNotification('Error updating password. Please try again.', 'error');
                try { if (window.loadCaptchaSecurity) window.loadCaptchaSecurity(); } catch (e) { }
            }
        });
    }
});

// NOTE: loadProfile function is defined at the top of the file

document.getElementById('deactivateUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/users/deactivate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            alert('User deactivated successfully');
            closeDeactivateUserModal();
        } else {
            const error = await response.json();
            alert('Error deactivating user: ' + error.message);
        }
    } catch (error) {
        alert('Error deactivating user: ' + error.message);
    }
});

// Coordinator Registration Management
async function loadPendingCoordinators() {
    try {
        const response = await fetch('/api/coordinators/pending');
        if (response.ok) {
            const coordinators = await response.json();
            const tableBody = document.getElementById('coordinatorRequestsTable');
            tableBody.innerHTML = '';
            
            coordinators.forEach(coordinator => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${coordinator.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${coordinator.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${coordinator.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="approveCoordinator('${coordinator.id}')" class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectCoordinator('${coordinator.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading pending coordinators:', error);
    }
}

async function approveCoordinator(id) {
    try {
        const response = await fetch(`/api/coordinators/${id}/approve`, {
            method: 'POST',
        });

        if (response.ok) {
            const data = await response.json();
            
            // Send approval email notification using EmailJS
            if (data.emailData && typeof emailjs !== 'undefined') {
                try {
                    await emailjs.send(
                        "service_upjalyd",
                        "nibfzmc",
                        {
                            coordinator_name: data.emailData.coordinator_name,
                            coordinator_email: data.emailData.coordinator_email,
                            to_email: data.emailData.to_email
                        }
                    );
                    console.log('Approval email sent successfully');
                } catch (emailError) {
                    console.error('Error sending approval email:', emailError);
                    // Don't fail the approval if email fails
                }
            }
            
            alert('Coordinator approved successfully! An email notification has been sent.');
            loadPendingCoordinators();
        } else {
            const error = await response.json();
            alert('Error approving coordinator: ' + error.message);
        }
    } catch (error) {
        alert('Error approving coordinator: ' + error.message);
    }
}

async function rejectCoordinator(id) {
    try {
        const response = await fetch(`/api/coordinators/${id}/reject`, {
            method: 'POST',
        });

        if (response.ok) {
            alert('Coordinator rejected successfully');
            loadPendingCoordinators();
        } else {
            const error = await response.json();
            alert('Error rejecting coordinator: ' + error.message);
        }
    } catch (error) {
        alert('Error rejecting coordinator: ' + error.message);
    }
}

// Helper function to format role
function formatRole(role) {
    // Split by underscore and capitalize each word
    return role
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

// Load user list
async function loadUserList() {
    try {
        const response = await fetch('/api/users');
        if (response.ok) {
            const users = await response.json();
            const tableBody = document.getElementById('userListTable');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${formatRole(user.role)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${user.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openUpdateUserModalWithData('${user.email}')" class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.active ? `
                            <button onclick="openDeactivateUserModalWithData('${user.email}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-user-slash"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Function to pre-fill update modal with user data
async function openUpdateUserModalWithData(email) {
    try {
        const response = await fetch(`/api/users/${email}`);
        if (response.ok) {
            const user = await response.json();
            const form = document.getElementById('updateUserForm');
            form.searchEmail.value = user.email;
            form.name.value = user.name;
            form.department.value = user.department;
            form.role.value = user.role;
            openUpdateUserModal();
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
    }
}

// Function to pre-fill deactivate modal
function openDeactivateUserModalWithData(email) {
    const form = document.getElementById('deactivateUserForm');
    form.email.value = email;
    openDeactivateUserModal();
}

// Refresh user list after actions
function refreshUserList() {
    loadUserList();
    loadPendingCoordinators();
}

// Update form submission to refresh list
document.getElementById('createUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/users/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            alert('User created successfully');
            closeCreateUserModal();
            refreshUserList();
        } else {
            const error = await response.json();
            alert('Error creating user: ' + error.message);
        }
    } catch (error) {
        alert('Error creating user: ' + error.message);
    }
});

document.getElementById('updateUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const email = formData.get('searchEmail');
    
    try {
        const response = await fetch('/api/users/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            alert('User updated successfully');
            closeUpdateUserModal();
            refreshUserList();
        } else {
            const error = await response.json();
            alert('Error updating user: ' + error.message);
        }
    } catch (error) {
        alert('Error updating user: ' + error.message);
    }
});

document.getElementById('deactivateUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/users/deactivate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
            alert('User deactivated successfully');
            closeDeactivateUserModal();
            refreshUserList();
        } else {
            const error = await response.json();
            alert('Error deactivating user: ' + error.message);
        }
    } catch (error) {
        alert('Error deactivating user: ' + error.message);
    }
});
