<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | ServiceEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/zxcvbn@4.4.2/dist/zxcvbn.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="../js/main.js" defer></script>
    <script src="../js/auth.js" defer></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("QjWuxszKzF9KLYlVZ");
        })();
    </script>
    
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDZn4tXSNQaDbuC4p1W7rlduN-Rl1C0CUo",
            authDomain: "serviceease-a6b2c.firebaseapp.com",
            projectId: "serviceease-a6b2c",
            storageBucket: "serviceease-a6b2c.firebasestorage.app",
            messagingSenderId: "588943303619",
            appId: "1:588943303619:web:7a2252e1959bb7d077d376",
            measurementId: "G-833XC06RBB"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // Initialize Analytics
        const analytics = firebase.analytics();
    </script>
    <style>
        /* Minimal reset */
        * { box-sizing: border-box; }
        html, body { min-height: 100%; margin: 0; background: white; }

        /* Make the registration form scroll naturally on small screens */
        .form-container { position: relative; padding: 14px; overflow: visible; background: transparent; }

        /* Steps visibility handling */
        .step { position: relative; width: 100%; transition: opacity 0.3s ease-in-out; }
        .step.hidden { opacity: 0; pointer-events: none; height: 0; }

        /* Compact inputs for mobile */
        .form-input { height: auto; }

        /* Progress: keep detailed progress for desktop, hide on mobile */
        .progress-container { position: relative; margin-bottom: 0.75rem; }
        .progress-bar { position: absolute; height: 2px; width: 100%; background: #e5e7eb; top: 50%; transform: translateY(-50%); }
        .progress-bar-fill { height: 100%; background: #111827; transition: width 0.5s ease; }
        .progress-steps { display: flex; justify-content: space-between; gap: 8px; }
        .progress-step { flex: 1; text-align: center; }
        .step-circle { width: 2.25rem; height: 2.25rem; border-radius: 50%; display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; background:white; }

        /* Mobile compact progress indicator */
        #mobileProgress { display: none; font-size: 0.95rem; color: #6b7280; margin-bottom: 0.5rem; }

        /* Password strength meter */
        .password-strength-meter { height: 4px; background-color: #E5E7EB; border-radius: 2px; margin-top: 0.5rem; overflow: hidden; }
        .password-strength-meter div { height: 100%; border-radius: 2px; transition: width 0.3s ease; }

        /* File preview size adjustments */
        .file-preview { width: 100%; height: 160px; border:2px dashed #d1d5db; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#f9fafb; overflow:hidden; }
        .file-preview img { max-width:100%; max-height:100%; object-fit:contain; }

        /* Responsive rules */
        @media (max-width: 1024px) {
            .progress-steps, .progress-bar { display: none; }
            #mobileProgress { display: block; }
            .grid-cols-2 { grid-template-columns: 1fr; }
            .grid-cols-3 { grid-template-columns: 1fr; }
            .file-preview { height: 140px; }
            .form-container { padding: 12px; }
        }
    </style>
</head>
<body class="m-0 p-0 bg-white">
    <div class="min-h-screen flex">
        <div class="flex w-full">
            <!-- Left Side Content -->
            <div class="hidden lg:flex lg:w-1/2 items-center justify-center bg-gray-50">
                <div class="text-center max-w-md">
                    <div class="w-64 h-64 mx-auto mb-6 overflow-hidden rounded-lg shadow-sm">
                        <img src="../images/SE-main.jpg" 
                             alt="ServiceEase" 
                             class="w-full h-full object-cover">
                    </div>
                    <h1 class="text-3xl font-light tracking-tight text-gray-900 mb-3">
                        ServiceEase
                    </h1>
                    <p class="text-gray-500 font-light">
                        Efficient Service Management
                    </p>
                </div>
            </div>

            <!-- Right Side Form -->
            <div class="w-full lg:w-1/2 flex items-center justify-center p-6">
                <div class="w-full max-w-2xl">
            <!-- Form Container -->
            <form id="registration-form" class="p-6" enctype="multipart/form-data">
                <!-- Progress Steps -->
                <div id="mobileProgress" class="lg:hidden text-sm text-gray-600 text-center mb-4">Step 1 of 5</div>
                <div class="progress-container mb-8">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: 20%"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step active">
                            <div class="step-circle shadow-md">
                                <i class="fas fa-building"></i>
                            </div>
                            <span class="step-text font-medium">Institution</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle shadow-md">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="step-text font-medium">Basic Info</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle shadow-md">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <span class="step-text font-medium">Email</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle shadow-md">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <span class="step-text font-medium">ID Verification</span>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle shadow-md">
                                <i class="fas fa-lock"></i>
                            </div>
                            <span class="step-text font-medium">Security</span>
                        </div>
                    </div>
                </div>

                <div class="form-container">
                    <!-- Step 1: Institution Selection -->
                    <div class="step" id="step1">
                        <div class="space-y-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-light text-gray-900 mb-1">Select Your Institution</h2>
                                <p class="text-xs text-gray-500">Choose the type of institution you belong to</p>
                            </div>
                            
                            <div class="space-y-6">
                                <!-- Institution Type Dropdown -->
                                <div class="form-group">
                                    <label for="institutionType" class="block text-sm font-medium text-gray-700 mb-2">Institution Type <span class="text-red-500">*</span></label>
                                    <select id="institutionType" name="institutionType" required
                                        class="form-input w-full px-4 py-2 border border-gray-300 border text-gray-900 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="" disabled selected>Select institution type</option>
                                        <option value="public_school">Public School</option>
                                        <option value="private_school">Private School</option>
                                        <option value="private_company">Private Company</option>
                                        <option value="lgu">Local Government Unit</option>
                                    </select>
                                </div>

                                <!-- Institution Selection -->
                                <div class="form-group">
                                    <label for="institutionSearch" class="block text-sm font-medium text-gray-700 mb-2">Select Your Institution <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="institutionSearch" name="institutionSearch" required
                                            class="form-input w-full px-4 py-2 border border-gray-300 border text-gray-900 
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Search for your institution..."
                                            autocomplete="off">
                                        <div id="institutionDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                                            <!-- Institution options will be populated here -->
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Can't find your institution? Contact the administrator to have it added.
                                    </p>
                                </div>

                                <!-- Selected Institution Details (Read-only) -->
                                <div id="selectedInstitutionDetails" class="form-group hidden">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <div class="flex items-start">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-building text-blue-600 mt-1"></i>
                                            </div>
                                            <div class="ml-3">
                                                <h4 class="text-sm font-medium text-blue-900">Selected Institution</h4>
                                                <div class="mt-1 text-sm">
                                                    <p id="selectedInstitutionName" class="text-blue-800 font-medium"></p>
                                                    <p id="selectedInstitutionType" class="text-blue-700"></p>
                                                    <p id="selectedInstitutionAddress" class="text-blue-700"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden fields for form submission -->
                                <input type="hidden" id="institutionName" name="institutionName">
                                <input type="hidden" id="institutionAddress" name="institutionAddress">
                                <input type="hidden" id="selectedInstitutionIdValue" name="selectedInstitutionId">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Basic Information -->
                    <div class="step hidden" id="step2">
                        <div class="space-y-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-light text-gray-900 mb-1">Basic Information</h2>
                                <p class="text-xs text-gray-500">Please provide your personal details</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-2">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="firstName" name="firstName" required
                                        class="form-input w-full px-4 py-3 border border-gray-300 text-gray-900 placeholder-gray-400 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                        transition-all duration-200 ease-in-out"
                                        placeholder="John"
                                            pattern="[A-Za-zñÑ\\. ]{2,}"
                                        title="Only letters, spaces, ñ, and . are allowed">
                                    <p class="field-error mt-1 text-sm text-red-600 hidden"></p>
                                </div>

                                <div class="form-group">
                                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-2">Last Name <span class="text-red-500">*</span></label>
                                    <input type="text" id="lastName" name="lastName" required
                                        class="form-input w-full px-4 py-3 border border-gray-300 text-gray-900 placeholder-gray-400 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                        transition-all duration-200 ease-in-out"
                                        placeholder="Doe"
                                            pattern="[A-Za-zñÑ\\. ]{2,}"
                                        title="Only letters, spaces, ñ, and . are allowed">
                                    <p class="field-error mt-1 text-sm text-red-600 hidden"></p>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Email Verification -->
                    <div class="step hidden" id="step3">
                        <div class="space-y-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-light text-gray-900 mb-1">Email Verification</h2>
                                <p class="text-xs text-gray-500">Verify your email address to continue</p>
                            </div>
                            <div class="form-group">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input type="email" id="email" name="email" required
                                        class="form-input w-full px-4 py-3 border border-gray-300 border text-gray-900 placeholder-gray-400 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                        transition-all duration-200 ease-in-out"
                                        placeholder="john.doe@example.com">
                                    <div class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <p class="field-error mt-1 text-sm text-red-600 hidden"></p>
                            </div>

                            <div class="flex items-center gap-4">
                                <button type="button" id="sendCodeBtn"
                                    class="px-4 py-2 bg-gray-900 text-white text-sm rounded-md
                                    hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900
                                    transition-all">
                                    Send Verification Code
                                </button>
                                <span id="codeSentMessage" class="text-sm text-green-600 hidden">
                                    Verification code sent!
                                </span>
                            </div>

                            <div class="form-group mt-6" id="verificationSection" style="display: none;">
                                <label for="verificationCode" class="block text-sm font-medium text-gray-700 mb-2">
                                    Verification Code <span class="text-red-500">*</span>
                                </label>
                                <div class="flex gap-2">
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                    <input type="text" maxlength="1" class="verification-input w-12 h-12 text-center text-2xl border rounded-md" />
                                </div>
                                <p class="mt-2 text-sm text-gray-500">Enter the 6-digit code sent to your email</p>
                                <div class="mt-4">
                                    <button type="button" id="verifyCodeBtn" 
                                        class="px-4 py-2 bg-gray-900 text-white text-sm rounded-md
                                        hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900
                                        transition-all">
                                        Verify Code
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mt-4 flex items-center justify-between">
                                    <span>Didn't receive the code?</span>
                                    <button type="button" id="resendCodeBtn" class="px-4 py-2 text-gray-900 hover:text-gray-700 text-sm bg-gray-100 hover:bg-gray-200 rounded-md transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-redo mr-2"></i>Resend code
                                    </button>
                                </p>
                            </div>

                            <div id="emailVerifiedMessage" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md hidden">
                                <div class="flex items-center text-green-700">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span>Email verified successfully!</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: ID Verification -->
                    <div class="step hidden" id="step4">
                        <div class="max-w-3xl mx-auto">
                            <div class="mb-6">
                                <h2 class="text-2xl font-light text-gray-900 mb-1">ID Verification</h2>
                                <p class="text-xs text-gray-500">Please provide clear photos of your valid ID</p>
                            </div>

                            <div class="bg-blue-50 border p-4 mb-8">
                                <div class="flex items-center text-blue-800">
                                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                    <span class="text-sm">Accepted formats: PNG, JPG (max 5MB)</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <!-- Front ID Upload -->
                                <div class="upload-container group" id="frontIdContainer">
                                    <input type="file" id="front-id-upload" name="frontId" accept="image/*" class="hidden" />
                                    <label for="front-id-upload" class="block w-full cursor-pointer">
                                        <div class="aspect-w-3 aspect-h-2 mb-2">
                                            <div class="upload-dropzone w-full h-full border-2 border-dashed border transition-all duration-200 group-hover:border-blue-500 flex flex-col items-center justify-center p-4">
                                                <div id="front-preview" class="hidden w-full h-full">
                                                    <img src="" alt="Front ID Preview" class="w-full h-full object-contain border">
                                                </div>
                                                <div id="front-placeholder" class="text-center">
                                                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                                    <p class="text-sm font-medium text-gray-900">Front of ID</p>
                                                    <p class="text-xs text-gray-500 mt-1">Click to upload</p>
                                                    <div class="mt-4 flex justify-center gap-4">
                                                        <button type="button" data-action="open-upload" data-target="front-id-upload" class="px-4 py-2 bg-gray-50 text-gray-600 border text-sm hover:bg-gray-100 transition-colors">
                                                            <i class="fas fa-upload mr-2"></i>Upload
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    <p class="field-error mt-2 text-sm text-red-600 hidden"></p>
                                </div>

                                <!-- Back ID Upload -->
                                <div class="upload-container group" id="backIdContainer">
                                    <input type="file" id="back-id-upload" name="backId" accept="image/*" class="hidden" />
                                    <label for="back-id-upload" class="block w-full cursor-pointer">
                                        <div class="aspect-w-3 aspect-h-2 mb-2">
                                            <div class="upload-dropzone w-full h-full border-2 border-dashed border transition-all duration-200 group-hover:border-blue-500 flex flex-col items-center justify-center p-4">
                                                <div id="back-preview" class="hidden w-full h-full">
                                                    <img src="" alt="Back ID Preview" class="w-full h-full object-contain border">
                                                </div>
                                                <div id="back-placeholder" class="text-center">
                                                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                                                    <p class="text-sm font-medium text-gray-900">Back of ID</p>
                                                    <p class="text-xs text-gray-500 mt-1">Click to upload</p>
                                                    <div class="mt-4 flex justify-center gap-4">
                                                        <button type="button" data-action="open-upload" data-target="back-id-upload" class="px-4 py-2 bg-gray-50 text-gray-600 border text-sm hover:bg-gray-100 transition-colors">
                                                            <i class="fas fa-upload mr-2"></i>Upload
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    <p class="field-error mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                            </div>

                            <!-- Selfie Upload -->
                            <div class="mt-6">
                                <div class="upload-container group" id="selfieContainer">
                                    <input type="file" id="selfie-upload" name="selfie" accept="image/*" class="hidden" />
                                    <label for="selfie-upload" class="block w-full cursor-pointer">
                                        <div class="aspect-w-16 aspect-h-9">
                                            <div class="upload-dropzone w-full h-full border-2 border-dashed border transition-all duration-200 group-hover:border-blue-500 flex flex-col items-center justify-center p-6">
                                                <div id="selfie-preview" class="hidden w-full h-full">
                                                    <img src="" alt="Selfie Preview" class="w-full h-full object-contain border">
                                                </div>
                                                <div id="selfie-placeholder" class="text-center">
                                                    <i class="fas fa-camera text-4xl text-gray-400 mb-3"></i>
                                                    <p class="text-sm font-medium text-gray-900">Selfie with ID</p>
                                                    <p class="text-xs text-gray-500 mt-1">Take a photo or upload one</p>
                                                    <div class="mt-4 flex justify-center gap-4">
                                                        <button type="button" data-action="take-photo" class="px-4 py-2 bg-blue-50 text-blue-600 border text-sm hover:bg-blue-100 transition-colors">
                                                            <i class="fas fa-camera mr-2"></i>Take Photo
                                                        </button>
                                                        <button type="button" data-action="open-upload" data-target="selfie-upload" class="px-4 py-2 bg-gray-50 text-gray-600 border text-sm hover:bg-gray-100 transition-colors">
                                                            <i class="fas fa-upload mr-2"></i>Upload
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                    <p class="field-error mt-2 text-sm text-red-600 hidden"></p>
                                </div>
                            </div>

                            <div class="flex justify-end mt-6">
                                <button type="button" id="clearUploadsBtn" class="px-4 py-2 bg-white text-gray-700 border text-sm rounded-md hover:bg-gray-50 transition-colors">
                                    <i class="fas fa-times mr-2"></i>Clear All Photos
                                </button>
                            </div>

                            <!-- Guidelines -->
                            <div class="mt-8 bg-gray-50 border p-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                    Photo Guidelines
                                </h4>
                                <ul class="text-sm text-gray-600 space-y-2">
                                    <li class="flex items-center">
                                        <i class="fas fa-check text-green-500 mr-2"></i>
                                        Ensure all text is clearly visible
                                    </li>
                                    <li class="flex items-center">
                                        <i class="fas fa-check text-green-500 mr-2"></i>
                                        Make sure the entire ID is within the frame
                                    </li>
                                    <li class="flex items-center">
                                        <i class="fas fa-check text-green-500 mr-2"></i>
                                        For selfie, hold your ID next to your face
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Security -->
                    <div class="step hidden" id="step5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input type="password" id="password" name="password" required
                                        class="form-input w-full px-4 py-2 border border-gray-300 border text-gray-900 placeholder-gray-400 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                        transition-all duration-200 ease-in-out"
                                        placeholder="Enter your password"
                                        minlength="8">
                                    <button type="button" data-toggle-password class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                                        onclick="togglePassword('password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div class="password-strength-meter mt-2">
                                    <div class="strength-0"></div>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">Password strength: <span id="password-strength-text">Very Weak</span></p>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input type="password" id="confirmPassword" name="confirmPassword" required
                                        class="form-input w-full px-4 py-2 border border-gray-300 border text-gray-900 placeholder-gray-400 
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent 
                                        transition-all duration-200 ease-in-out"
                                        placeholder="Confirm your password">
                                    <button type="button" data-toggle-password class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                                        onclick="togglePassword('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <p class="field-error mt-1 text-sm text-red-600 hidden"></p>
                            </div>
                        </div>
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-500">
                                By continuing, you agree to ServiceEase's 
                                <a href="#" class="text-blue-600 hover:text-blue-500">terms of service</a> and 
                                <a href="#" class="text-blue-600 hover:text-blue-500">privacy policy</a>.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex items-center justify-between mt-4">
                    <div>
                        <button type="button" id="prevBtn" 
                            class="px-5 py-2 border border-gray-300 text-gray-700 text-sm rounded-md
                            focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900
                            transition-all"
                            style="display: none;">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Previous
                        </button>
                        <p id="signInText" class="text-sm text-gray-600">
                            Already have an account?
                            <a href="/login" class="text-indigo-600 font-medium hover:text-indigo-700"> Sign in</a>
                        </p>
                    </div>
                    <div>
                        <button type="button" id="nextBtn"
                            class="px-5 py-2 bg-gray-900 text-white text-sm rounded-md
                            hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900
                            transition-all">
                            Next
                            <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        <button type="submit" id="submitBtn" 
                            class="px-5 py-2 bg-gray-900 text-white text-sm rounded-md
                            hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900
                            transition-all"
                            style="display: none;">
                            Create Account
                            <i class="fas fa-check ml-2"></i>
                        </button>
                    </div>
                </div>


            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize EmailJS with your public key
            (function() {
                emailjs.init("QjWuxszKzF9KLYlVZ");
            })();

            // Firebase Auth instance
            const auth = firebase.auth();
            let currentUser = null;
            let verificationCode = null;

            // Email verification handling
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const verifyCodeBtn = document.getElementById('verifyCodeBtn');
            const resendCodeBtn = document.getElementById('resendCodeBtn');
            const codeSentMessage = document.getElementById('codeSentMessage');
            const verificationSection = document.getElementById('verificationSection');
            const emailVerifiedMessage = document.getElementById('emailVerifiedMessage');
            const verificationInputs = document.querySelectorAll('.verification-input');
            
            // Handle verification code input
            verificationInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        if (index < verificationInputs.length - 1) {
                            verificationInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        verificationInputs[index - 1].focus();
                    }
                });
            });

            function generateVerificationCode() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            let resendCooldown = 0;
            let resendInterval = null;

            function startResendCooldown() {
                resendCooldown = 60; // 60 seconds cooldown
                resendCodeBtn.disabled = true;
                
                resendInterval = setInterval(() => {
                    resendCooldown--;
                    if (resendCooldown > 0) {
                        resendCodeBtn.textContent = `Resend code (${resendCooldown}s)`;
                    } else {
                        clearInterval(resendInterval);
                        resendCodeBtn.disabled = false;
                        resendCodeBtn.textContent = 'Resend code';
                    }
                }, 1000);
            }

            async function sendVerificationCode() {
                const emailInput = document.getElementById('email');
                const email = emailInput.value.trim();
                
                if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                    showEmailError('Please enter a valid email address');
                    return;
                }
                
                // Check if email already exists BEFORE sending verification code
                try {
                    sendCodeBtn.disabled = true;
                    sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking email...';
                    
                    const checkResponse = await fetch('/api/check-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    if (!checkResponse.ok) {
                        throw new Error('Server error checking email');
                    }
                    
                    const checkData = await checkResponse.json();
                    
                    if (checkData.exists) {
                        showEmailError('This email is already registered. Please use a different email or log in.');
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.innerHTML = 'Send Verification Code';
                        return;
                    }
                    
                    // Clear any previous errors since email is valid and not taken
                    clearEmailError();
                    
                } catch (error) {
                    console.error('Email check error:', error);
                    console.error('Error details:', {
                        message: error.message,
                        type: error.name,
                        stack: error.stack
                    });
                    showEmailError('Unable to check email availability. Please ensure you are accessing this page via http://localhost:3000 and the server is running.');
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.innerHTML = 'Send Verification Code';
                    return;
                }

                // Only send verification code if email is available
                try {
                    sendCodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending code...';
                    verificationCode = generateVerificationCode();
                    
                    // Send email using EmailJS
                    console.log("Sending email to:", email);
                    // Log the parameters for debugging
                    const templateParams = {
                        email: email,  // This matches the {{email}} in template
                        passcode: verificationCode,
                        time: new Date(Date.now() + 15 * 60000).toLocaleString(),
                        from_name: "ServiceEase",
                        from_email: "serviceeaseph@gmail.com"
                    };
                    console.log("Template params:", templateParams);

                    const response = await emailjs.send(
                        "service_upjalyd",
                        "template_5js5lu3",
                        templateParams
                    ).then(
                        (response) => {
                            console.log("SUCCESS!", response.status, response.text);
                            return response;
                        },
                        (err) => {
                            console.log("FAILED...", err);
                            throw err;
                        }
                    );
                    
                    // Show verification input section
                    codeSentMessage.classList.remove('hidden');
                    codeSentMessage.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verification code sent!';
                    verificationSection.style.display = 'block';
                    sendCodeBtn.disabled = true;
                    sendCodeBtn.classList.add('opacity-50');
                    sendCodeBtn.innerHTML = 'Code Sent';
                    
                    // Start resend cooldown
                    startResendCooldown();
                    
                    // Auto-focus first verification input
                    setTimeout(() => verificationInputs[0].focus(), 100);

                } catch (error) {
                    console.error('Error:', error);
                    let errorMessage = 'Error sending verification code. ';
                    if (error.message) {
                        errorMessage += error.message;
                    } else if (error.text) {
                        errorMessage += error.text;
                    }
                    alert(errorMessage);
                    
                    // Reset button state
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.classList.remove('opacity-50');
                }
            }

            function verifyCode() {
                const enteredCode = Array.from(verificationInputs)
                    .map(input => input.value)
                    .join('');

                if (enteredCode === verificationCode) {
                    isEmailVerified = true;
                    emailVerifiedMessage.classList.remove('hidden');
                    verificationSection.style.display = 'none';
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50');
                    
                    // Clear verification inputs
                    verificationInputs.forEach(input => input.value = '');
                    
                    // Update UI to show verified state
                    sendCodeBtn.style.display = 'none';
                    const emailInput = document.getElementById('email');
                    emailInput.disabled = true;
                    emailInput.classList.add('bg-gray-100');
                } else {
                    alert('Invalid verification code. Please try again.');
                    // Clear verification inputs for retry
                    verificationInputs.forEach(input => input.value = '');
                    verificationInputs[0].focus();
                }
            }

            function showEmailError(message) {
                const emailInput = document.getElementById('email');
                const formGroup = emailInput.parentElement.parentElement;
                let errorEl = formGroup.querySelector('.text-red-600');
                
                if (!errorEl) {
                    errorEl = document.createElement('p');
                    errorEl.className = 'mt-1 text-sm text-red-600';
                    formGroup.appendChild(errorEl);
                }
                
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                emailInput.classList.add('border-red-500');
            }
            
            function clearEmailError() {
                const emailInput = document.getElementById('email');
                const formGroup = emailInput.parentElement.parentElement;
                const errorEl = formGroup.querySelector('.text-red-600');
                
                if (errorEl) {
                    errorEl.classList.add('hidden');
                }
                emailInput.classList.remove('border-red-500');
            }
            
            // Clear error when user starts typing
            document.getElementById('email').addEventListener('input', clearEmailError);

            // Event listeners for verification buttons
            sendCodeBtn.addEventListener('click', sendVerificationCode);
            verifyCodeBtn.addEventListener('click', verifyCode);
            resendCodeBtn.addEventListener('click', () => {
                if (!resendCodeBtn.disabled) {
                    codeSentMessage.classList.add('hidden');
                    sendVerificationCode();
                }
            });
            // Helper function to add error messages
            function addErrorMessage(field, message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message text-sm text-red-500 mt-1';
                errorDiv.textContent = message;
                field.parentElement.appendChild(errorDiv);
            }

            // Handle institution type selection
            const institutionTypeSelect = document.getElementById('institutionType');
            
            // Add event listener to filter institutions when type changes
            institutionTypeSelect.addEventListener('change', function() {
                const searchInput = document.getElementById('institutionSearch');
                // Clear current search
                searchInput.value = '';
                selectedInstitution = null;
                document.getElementById('selectedInstitutionDetails').classList.add('hidden');
                
                // Filter and show institutions for selected type
                if (this.value) {
                    const filteredByType = getFilteredInstitutionsByType(this.value);
                    showDropdown(filteredByType);
                } else {
                    hideDropdown();
                }
            });

            // Institution search functionality
            let availableInstitutions = [];
            let selectedInstitution = null;
            
            // Function to filter institutions by type
            function getFilteredInstitutionsByType(type) {
                if (!type) return availableInstitutions;
                return availableInstitutions.filter(inst => inst.type === type);
            }
            
            // Load institutions from API
            async function loadInstitutions() {
                try {
                    // Try the public endpoint first, fallback to regular endpoint
                    let response = await fetch('/api/institutions/public');
                    if (!response.ok) {
                        console.log('Public endpoint failed, trying regular endpoint...');
                        response = await fetch('/api/institutions');
                    }
                    
                    if (response.ok) {
                        availableInstitutions = await response.json();
                        // Sort by name for better UX
                        availableInstitutions.sort((a, b) => a.name.localeCompare(b.name));
                        console.log('Loaded institutions:', availableInstitutions.length);
                        console.log('Available institutions:', availableInstitutions);
                    } else {
                        console.error('Failed to load institutions from both endpoints');
                        alert('Unable to load institutions. Please refresh the page or contact support.');
                    }
                } catch (error) {
                    console.error('Error loading institutions:', error);
                    alert('Error loading institutions. Please check your connection and try again.');
                }
            }
            
            // Setup institution search functionality
            function setupInstitutionSearch() {
                const searchInput = document.getElementById('institutionSearch');
                const dropdown = document.getElementById('institutionDropdown');
                const typeSelect = document.getElementById('institutionType');
                
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    const selectedType = typeSelect.value;
                    
                    // First filter by type if selected
                    let baseInstitutions = selectedType ? 
                        getFilteredInstitutionsByType(selectedType) : 
                        availableInstitutions;
                    
                    if (searchTerm.length === 0) {
                        // Show institutions filtered by type when search is empty
                        showDropdown(baseInstitutions);
                        return;
                    }
                    
                    if (searchTerm.length < 1) {
                        hideDropdown();
                        return;
                    }
                    
                    // Filter by search term within the type-filtered list
                    const filteredInstitutions = baseInstitutions.filter(inst => 
                        inst.name.toLowerCase().includes(searchTerm) ||
                        inst.address.toLowerCase().includes(searchTerm)
                    );
                    
                    showDropdown(filteredInstitutions);
                });
                
                searchInput.addEventListener('focus', function() {
                    const selectedType = typeSelect.value;
                    
                    // Get institutions filtered by type
                    let baseInstitutions = selectedType ? 
                        getFilteredInstitutionsByType(selectedType) : 
                        availableInstitutions;
                    
                    // Show institutions filtered by type when user clicks the search bar
                    if (this.value.length === 0) {
                        showDropdown(baseInstitutions);
                    } else {
                        const searchTerm = this.value.toLowerCase().trim();
                        const filteredInstitutions = baseInstitutions.filter(inst => 
                            inst.name.toLowerCase().includes(searchTerm) ||
                            inst.address.toLowerCase().includes(searchTerm)
                        );
                        showDropdown(filteredInstitutions);
                    }
                });
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        hideDropdown();
                    }
                });
            }
            
            function showDropdown(institutions) {
                const dropdown = document.getElementById('institutionDropdown');
                dropdown.innerHTML = '';
                
                if (availableInstitutions.length === 0) {
                    dropdown.innerHTML = `
                        <div class="p-3 text-sm text-gray-500 text-center">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading institutions...
                        </div>
                    `;
                } else if (institutions.length === 0) {
                    dropdown.innerHTML = `
                        <div class="p-3 text-sm text-gray-500 text-center">
                            <i class="fas fa-search mr-2"></i>No institutions found
                            <div class="text-xs mt-1">Try a different search term</div>
                        </div>
                    `;
                } else {
                    institutions.forEach(institution => {
                        const option = document.createElement('div');
                        option.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                        option.innerHTML = `
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-building text-gray-400"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="text-sm font-medium text-gray-900">${institution.name}</div>
                                    <div class="text-xs text-gray-400">${institution.address}</div>
                                </div>
                            </div>
                        `;
                        
                        option.addEventListener('click', () => selectInstitution(institution));
                        dropdown.appendChild(option);
                    });
                }
                
                dropdown.classList.remove('hidden');
            }
            
            function hideDropdown() {
                document.getElementById('institutionDropdown').classList.add('hidden');
            }
            
            function selectInstitution(institution) {
                selectedInstitution = institution;
                
                // Update search input
                document.getElementById('institutionSearch').value = institution.name;
                
                // Update hidden fields
                document.getElementById('institutionName').value = institution.name;
                document.getElementById('institutionAddress').value = institution.address;
                document.getElementById('selectedInstitutionIdValue').value = institution.institution_id;
                
                // Update institution type dropdown
                document.getElementById('institutionType').value = institution.type;
                
                // Show selected institution details
                document.getElementById('selectedInstitutionName').textContent = institution.name;
                document.getElementById('selectedInstitutionType').textContent = formatInstitutionType(institution.type);
                document.getElementById('selectedInstitutionAddress').textContent = institution.address;
                document.getElementById('selectedInstitutionDetails').classList.remove('hidden');
                
                // Hide dropdown
                hideDropdown();
                
                console.log('Selected institution:', institution);
            }
            
            function formatInstitutionType(type) {
                const typeMap = {
                    'public_school': 'Public School',
                    'private_school': 'Private School',
                    'private_company': 'Private Company',
                    'lgu': 'Local Government Unit'
                };
                return typeMap[type] || type;
            }

            // Multi-step form handling
            let currentStep = 1;
            const totalSteps = 5;
            const form = document.getElementById('registration-form');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.querySelector('.progress-bar-fill');
            const progressSteps = document.querySelectorAll('.progress-step');
            const signInText = document.getElementById('signInText');

            // Function to update progress bar and steps
            function updateProgress() {
                const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
                progressBar.style.width = `${progress}%`;

                // Update progress steps
                progressSteps.forEach((step, index) => {
                    if (index + 1 < currentStep) {
                        step.classList.remove('active');
                        step.classList.add('completed');
                    } else if (index + 1 === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
            }

            // Function to show/hide steps
            function showStep(stepNumber) {
                // Hide all steps first
                document.querySelectorAll('.step').forEach((step, index) => {
                    if (index + 1 === stepNumber) {
                        step.classList.remove('hidden');
                        step.style.display = 'block';
                        step.style.visibility = 'visible';
                        step.style.opacity = '1';
                        step.style.height = 'auto';
                    } else {
                        step.classList.add('hidden');
                        step.style.display = 'none';
                        step.style.visibility = 'hidden';
                        step.style.opacity = '0';
                        step.style.height = '0';
                    }
                });

                // Update navigation elements
                if (stepNumber === 1) {
                    prevBtn.style.display = 'none';
                    signInText.style.display = 'block';
                } else {
                    prevBtn.style.display = 'block';
                    signInText.style.display = 'none';
                }

                if (stepNumber === totalSteps) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'block';

                } else {
                    nextBtn.style.display = 'block';
                    submitBtn.style.display = 'none';

                }

                // Update progress
                updateProgress();
            }

            // Function to validate current step
            function validateStep(step) {
                let isValid = true;
                const currentStepElement = document.getElementById(`step${step}`);
                
                if (step === 1) {
                    // Validate institution selection
                    const institutionType = document.getElementById('institutionType');
                    const institutionSearch = document.getElementById('institutionSearch');
                    const institutionName = document.getElementById('institutionName');

                    // Reset error states
                    [institutionType, institutionSearch].forEach(field => {
                        field.classList.remove('border-red-500');
                        const errorMessage = field.parentElement.querySelector('.error-message');
                        if (errorMessage) errorMessage.remove();
                    });

                    // Check if an institution is selected
                    if (!selectedInstitution) {
                        isValid = false;
                        institutionSearch.classList.add('border-red-500');
                        addErrorMessage(institutionSearch, 'Please select an institution from the list');
                    }

                    // Check institution type (should be auto-filled when institution is selected)
                    if (!institutionType.value) {
                        isValid = false;
                        institutionType.classList.add('border-red-500');
                        addErrorMessage(institutionType, 'Please select an institution type');
                    }

                    return isValid;
                }

                // Get all required fields in the current step
                const requiredFields = currentStepElement.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    // Reset error state
                    field.classList.remove('border-red-500');
                    const errorMessage = field.parentElement.querySelector('.field-error');
                    if (errorMessage) {
                        errorMessage.classList.add('hidden');
                    }

                    // Check if field is empty
                    if (!field.value) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        if (errorMessage) {
                            errorMessage.textContent = `Please enter your ${field.name}`;
                            errorMessage.classList.remove('hidden');
                        }
                    }

                    // Additional validation for specific fields
                    if (field.id === 'firstName' || field.id === 'lastName') {
                        if (!field.value.match(/^[A-Za-zñÑ\\. ]{2,}$/)) {
                            isValid = false;
                            field.classList.add('border-red-500');
                            if (errorMessage) {
                                errorMessage.textContent = 'Special characters are not allowed (ñ and . are okay)';
                                errorMessage.classList.remove('hidden');
                            }
                        }
                    }

                    if (field.id === 'email') {
                        if (!field.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                            isValid = false;
                            field.classList.add('border-red-500');
                            if (errorMessage) {
                                errorMessage.textContent = 'Please enter a valid email address';
                                errorMessage.classList.remove('hidden');
                            }
                        }
                    }

                    // Select fields validation
                    if (field.tagName === 'SELECT') {
                        if (!field.value) {
                            isValid = false;
                            field.classList.add('border-red-500');
                            if (errorMessage) {
                                errorMessage.textContent = `Please select your ${field.name}`;
                                errorMessage.classList.remove('hidden');
                            }
                        }
                    }
                });

                if (step === 4) {
                    const fileFields = [
                        {
                            input: document.getElementById('front-id-upload'),
                            container: document.getElementById('frontIdContainer'),
                            message: 'Please upload the front of your ID'
                        },
                        {
                            input: document.getElementById('back-id-upload'),
                            container: document.getElementById('backIdContainer'),
                            message: 'Please upload the back of your ID'
                        },
                        {
                            input: document.getElementById('selfie-upload'),
                            container: document.getElementById('selfieContainer'),
                            message: 'Please upload a selfie with your ID'
                        },
                    ];

                    fileFields.forEach(({ input, container, message }) => {
                        if (!input || !container) return;
                        container.classList.remove('error');
                        const errorEl = container.querySelector('.field-error');
                        if (errorEl) errorEl.classList.add('hidden');

                        if (!input.files || !input.files.length) {
                            isValid = false;
                            container.classList.add('error');
                            if (errorEl) {
                                errorEl.textContent = message;
                                errorEl.classList.remove('hidden');
                            }
                        }
                    });
                }

                // If this is the final security step, ensure password and confirm password match
                if (step === totalSteps) {
                    const pwd = document.getElementById('password');
                    const confirmPwd = document.getElementById('confirmPassword');
                    if (pwd && confirmPwd) {
                        const formGroup = confirmPwd.closest('.form-group');
                        const confirmMsg = formGroup ? formGroup.querySelector('.text-red-600') : null;
                        if (pwd.value !== confirmPwd.value) {
                            isValid = false;
                            confirmPwd.classList.add('border-red-500');
                            if (confirmMsg) {
                                confirmMsg.textContent = 'Passwords do not match.';
                                confirmMsg.classList.remove('hidden');
                            }
                        } else {
                            if (confirmMsg) confirmMsg.classList.add('hidden');
                            confirmPwd.classList.remove('border-red-500');
                        }
                    }
                }

                return isValid;
            }

            // Track email verification status
            let isEmailVerified = false;

            // Update compact mobile progress indicator
            function updateMobileProgress() {
                const mobileEl = document.getElementById('mobileProgress');
                if (!mobileEl) return;
                const total = document.querySelectorAll('.step').length || 5;
                mobileEl.textContent = `Step ${currentStep} of ${total}`;
            }

            // Next button click handler with validation
            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    // Check if we're on the email verification step
                    if (currentStep === 3 && !isEmailVerified) {
                        alert('Please verify your email address using the verification code sent to your email.');
                        return;
                    }
                    
                    currentStep++;
                    showStep(currentStep);
                    updateMobileProgress();
                    window.scrollTo(0, 0);
                }
            });

            // Previous button click handler
            prevBtn.addEventListener('click', () => {
                currentStep--;
                showStep(currentStep);
                updateMobileProgress();
                window.scrollTo(0, 0);
            });

            // Initialize first step
            showStep(1);
            updateMobileProgress();
            
            // Load institutions and setup search
            setupInstitutionSearch(); // Setup immediately so user can click
            loadInstitutions(); // Load data in background

            window.togglePassword = function(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;
                const toggleBtn = input.parentElement.querySelector('[data-toggle-password]');
                const icon = toggleBtn ? toggleBtn.querySelector('i') : null;
                const shouldReveal = input.type === 'password';
                
                input.type = shouldReveal ? 'text' : 'password';
                if (icon) {
                    icon.classList.toggle('fa-eye', !shouldReveal);
                    icon.classList.toggle('fa-eye-slash', shouldReveal);
                }
            }

            function clearUploadField(inputId, previewId, placeholderId) {
                const input = document.getElementById(inputId);
                const preview = previewId ? document.getElementById(previewId) : null;
                const placeholder = placeholderId ? document.getElementById(placeholderId) : null;

                if (input) {
                    input.value = '';
                }
                if (preview) {
                    const img = preview.querySelector('img');
                    if (img) img.src = '';
                    preview.classList.add('hidden');
                }
                if (placeholder) {
                    placeholder.classList.remove('hidden');
                }

                if (input) {
                    const container = input.closest('.upload-container');
                    if (container) {
                        container.classList.remove('error');
                        const errorMsg = container.querySelector('.field-error');
                        if (errorMsg) errorMsg.classList.add('hidden');
                    }
                }
            }

            // Handle image uploads and previews
            function handleImageUpload(inputId, previewId, placeholderId) {
                const input = document.getElementById(inputId);
                const preview = document.getElementById(previewId);
                const placeholder = document.getElementById(placeholderId);
                const img = preview.querySelector('img');

                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) { // 5MB limit
                            alert('File size must be less than 5MB');
                            input.value = '';
                            return;
                        }

                        if (!file.type.startsWith('image/')) {
                            alert('Please upload an image file');
                            input.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            img.src = e.target.result;
                            preview.classList.remove('hidden');
                            placeholder.classList.add('hidden');
                            const container = input.closest('.upload-container');
                            const errorMsg = container ? container.querySelector('.field-error') : null;
                            if (container) container.classList.remove('error');
                            if (errorMsg) errorMsg.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Initialize file upload handlers
            handleImageUpload('front-id-upload', 'front-preview', 'front-placeholder');
            handleImageUpload('back-id-upload', 'back-preview', 'back-placeholder');
            handleImageUpload('selfie-upload', 'selfie-preview', 'selfie-placeholder');

            // Handle camera capture for selfie
            const takeSelfieBtn = document.querySelector('[data-action="take-photo"]');
            if (takeSelfieBtn) {
                takeSelfieBtn.addEventListener('click', async function() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'user',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            } 
                        });

                        // Create a modal for the camera
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                                <h3 class="text-xl font-bold text-gray-900 mb-4 text-center">Take Your Selfie</h3>
                                <div class="relative bg-black rounded-lg overflow-hidden mb-4">
                                    <video id="camera-video" autoplay playsinline class="w-full h-auto" style="transform: scaleX(-1);"></video>
                                </div>
                                <div class="flex justify-center gap-4">
                                    <button id="capture-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-camera mr-2"></i>Capture Photo
                                    </button>
                                    <button id="cancel-btn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-times mr-2"></i>Cancel
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 text-center mt-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Make sure your face is clearly visible
                                </p>
                            </div>
                        `;

                        document.body.appendChild(modal);
                        
                        // Get the video element and attach stream
                        const videoElement = modal.querySelector('#camera-video');
                        videoElement.srcObject = stream;
                        
                        // Wait for video to be ready
                        videoElement.onloadedmetadata = () => {
                            videoElement.play();
                        };

                        // Capture button handler
                        modal.querySelector('#capture-btn').addEventListener('click', () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = videoElement.videoWidth;
                            canvas.height = videoElement.videoHeight;
                            
                            // Flip the image back (since we mirrored it for preview)
                            const ctx = canvas.getContext('2d');
                            ctx.translate(canvas.width, 0);
                            ctx.scale(-1, 1);
                            ctx.drawImage(videoElement, 0, 0);
                            
                            // Convert canvas to blob then to File
                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    alert('Failed to capture photo. Please try again.');
                                    return;
                                }
                                
                                // Create a File object from the blob
                                const file = new File([blob], `selfie-${Date.now()}.jpg`, { type: 'image/jpeg' });
                                
                                // Create a DataTransfer object to set the file input
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                
                                // Update the file input with the captured photo
                                const selfieInput = document.getElementById('selfie-upload');
                                selfieInput.files = dataTransfer.files;
                                
                                // Update preview
                                const selfiePreview = document.getElementById('selfie-preview');
                                const selfiePlaceholder = document.getElementById('selfie-placeholder');
                                const selfieImg = selfiePreview.querySelector('img');
                                selfieImg.src = canvas.toDataURL('image/jpeg');
                                selfiePreview.classList.remove('hidden');
                                selfiePlaceholder.classList.add('hidden');
                                
                                console.log('Selfie captured and saved to file input:', file.name, 'Size:', file.size, 'bytes');
                                
                                // Cleanup
                                stream.getTracks().forEach(track => track.stop());
                                modal.remove();
                            }, 'image/jpeg', 0.92);
                        });

                        // Cancel button handler
                        modal.querySelector('#cancel-btn').addEventListener('click', () => {
                            stream.getTracks().forEach(track => track.stop());
                            modal.remove();
                        });

                        // Close on background click
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                stream.getTracks().forEach(track => track.stop());
                                modal.remove();
                            }
                        });
                    } catch (err) {
                        console.error('Camera access error:', err);
                        alert('Could not access camera. Please make sure you have granted camera permissions and your camera is not being used by another application.');
                    }
                });
            }

            document.querySelectorAll('[data-action="open-upload"]').forEach(button => {
                const targetId = button.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (!input) return;
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    input.click();
                });
            });

            const clearUploadsBtn = document.getElementById('clearUploadsBtn');
            if (clearUploadsBtn) {
                clearUploadsBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    clearUploadField('front-id-upload', 'front-preview', 'front-placeholder');
                    clearUploadField('back-id-upload', 'back-preview', 'back-placeholder');
                    clearUploadField('selfie-upload', 'selfie-preview', 'selfie-placeholder');
                });
            }

            // Handle form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (validateStep(currentStep)) {
                    try {
                        // Show loading state
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Account...';

                        // Collect form data - only send institution_id, server will JOIN for details
                        const formData = {
                            firstName: document.getElementById('firstName').value,
                            lastName: document.getElementById('lastName').value,
                            email: document.getElementById('email').value,
                            password: document.getElementById('password').value,
                            institutionId: document.getElementById('selectedInstitutionIdValue').value
                        };

                        // Debug: Check if files are present
                        const frontIdInput = document.getElementById('front-id-upload');
                        const backIdInput = document.getElementById('back-id-upload');
                        const selfieInput = document.getElementById('selfie-upload');
                        
                        console.log('File inputs check:', {
                            frontId: frontIdInput && frontIdInput.files[0] ? frontIdInput.files[0].name : 'NO FILE',
                            backId: backIdInput && backIdInput.files[0] ? backIdInput.files[0].name : 'NO FILE',
                            selfie: selfieInput && selfieInput.files[0] ? selfieInput.files[0].name : 'NO FILE'
                        });

                        // Call the registration function from auth.js
                        const result = await registerUser(formData);
                        
                        // Show success modal
                        const successModal = document.createElement('div');
                        successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        successModal.innerHTML = `
                            <div class="bg-white rounded-xl p-10 max-w-sm w-full mx-4 shadow-sm">
                                <div class="text-center">
                                    <!-- Success Icon -->
                                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100 mb-6">
                                        <i class="fas fa-check text-xl text-gray-900"></i>
                                    </div>
                                    
                                    <!-- Title -->
                                    <h2 class="text-2xl font-light text-gray-900 mb-3">Registration Successful</h2>
                                    
                                    <!-- Message -->
                                    <div class="mb-8">
                                        <p class="text-sm text-gray-500 mb-1">Your account has been created successfully.</p>
                                        <p class="text-sm text-gray-500">Please wait for admin approval.</p>
                                    </div>
                                    
                                    <!-- Progress Indicator -->
                                    <div class="flex items-center justify-center gap-3 mb-8">
                                        <div class="flex flex-col items-center">
                                            <div class="w-7 h-7 rounded-full bg-gray-900 flex items-center justify-center mb-1">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </div>
                                            <span class="text-xs text-gray-600">Registration</span>
                                        </div>
                                        <div class="w-16 h-px bg-gray-200 mt-[-20px]"></div>
                                        <div class="flex flex-col items-center">
                                            <div class="w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center mb-1">
                                                <i class="fas fa-clock text-gray-400 text-xs"></i>
                                            </div>
                                            <span class="text-xs text-gray-400">Approval</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Button -->
                                    <button onclick="window.location.href='/login.html'" 
                                        class="w-full py-2.5 px-4 bg-gray-900 text-white text-sm rounded-md hover:bg-gray-800 
                                        focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 
                                        transition-all">
                                        Go to Login
                                    </button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(successModal);
                        
                        // Add fade-in animation style
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes fade-in-up {
                                0% {
                                    opacity: 0;
                                    transform: translateY(20px);
                                }
                                100% {
                                    opacity: 1;
                                    transform: translateY(0);
                                }
                            }
                            .animate-fade-in-up {
                                animation: fade-in-up 0.5s ease-out;
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // Redirect after a delay
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 5000); // 5 seconds delay
                    } catch (error) {
                        console.error('Registration error:', error);
                        alert(error.message || 'Registration failed. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Create Account<i class="fas fa-check ml-2"></i>';
                    }
                    }
                });

            // Password strength meter and confirm-password validation
            (function setupPasswordStrength() {
                const pwdInput = document.getElementById('password');
                const confirmInput = document.getElementById('confirmPassword');
                const strengthBar = document.querySelector('.password-strength-meter div');
                const strengthText = document.getElementById('password-strength-text');

                if (!pwdInput || !strengthBar || !strengthText) return;

                const labels = ['Very Weak', 'Weak', 'Fair', 'Strong', 'Very Strong'];

                function updateStrength() {
                    const value = pwdInput.value || '';
                    let score = 0;
                    try {
                        if (window.zxcvbn && typeof window.zxcvbn === 'function') {
                            const result = window.zxcvbn(value);
                            score = Math.max(0, Math.min(4, parseInt(result.score || 0, 10)));
                        } else {
                            // fallback heuristic
                            if (value.length >= 12) score = 4;
                            else if (value.length >= 10) score = 3;
                            else if (value.length >= 8) score = 2;
                            else if (value.length >= 6) score = 1;
                            else score = 0;
                        }
                    } catch (e) {
                        console.warn('zxcvbn error', e);
                        score = 0;
                    }

                    // Debug - helpful when troubleshooting in browser console
                    try { console.debug('updateStrength', { value: value, score: score, hasZxcvbn: !!window.zxcvbn }); } catch(e) {}

                    strengthBar.className = '';
                    strengthBar.classList.add('strength-' + score);
                    strengthText.textContent = labels[score] || labels[0];

                    strengthBar.setAttribute('aria-valuenow', score);
                    strengthBar.setAttribute('aria-valuemin', 0);
                    strengthBar.setAttribute('aria-valuemax', 4);

                    if (pwdInput.required && pwdInput.minLength) {
                        const min = parseInt(pwdInput.getAttribute('minlength') || '0', 10);
                        if (value.length > 0 && value.length < min) {
                            pwdInput.classList.add('border-red-500');
                        } else {
                            pwdInput.classList.remove('border-red-500');
                        }
                    }

                    checkConfirm();
                }

                function checkConfirm() {
                    if (!confirmInput) return;
                    const formGroup = confirmInput.closest('.form-group');
                    const msgEl = formGroup ? formGroup.querySelector('.text-red-600') : null;
                    if (!confirmInput.value) {
                        if (msgEl) msgEl.classList.add('hidden');
                        confirmInput.classList.remove('border-red-500');
                        return;
                    }

                    if (pwdInput.value !== confirmInput.value) {
                        if (msgEl) {
                            msgEl.textContent = 'Passwords do not match.';
                            msgEl.classList.remove('hidden');
                        }
                        confirmInput.classList.add('border-red-500');
                    } else {
                        if (msgEl) msgEl.classList.add('hidden');
                        confirmInput.classList.remove('border-red-500');
                    }
                }

                let timeout;
                const scheduleUpdate = () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(updateStrength, 120);
                };

                ['input','keyup','change','paste','blur'].forEach(ev => {
                    pwdInput.addEventListener(ev, scheduleUpdate);
                });

                if (confirmInput) {
                    ['input','change','paste'].forEach(ev => confirmInput.addEventListener(ev, checkConfirm));
                }

                // Run update a few times in the first 3s to catch browser autofill
                updateStrength();
                const poll = setInterval(updateStrength, 500);
                setTimeout(() => clearInterval(poll), 3000);
            })();

        });
    </script>
</body>
</html> 