<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institutional Client Institution Admin Portal | ServiceEase</title>
    
    <!-- AUTHENTICATION CHECK - Runs before page renders -->
    <script>
        (function() {
            // If already redirecting to login, stop
            if (sessionStorage.getItem('redirecting_to_login') === 'true') {
                window.location.replace('/pages/login.html');
                return;
            }
            
            // Check authentication immediately
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!isLoggedIn || !userStr || !token) {
                // Not logged in - redirect to login
                console.log('?? No auth data - redirecting to login');
                sessionStorage.setItem('redirecting_to_login', 'true');
                window.location.replace('/pages/login.html');
                return;
            }
            
            try {
                const user = JSON.parse(userStr);
                // Check if user is institution_admin
                if (user.role !== 'institution_admin') {
                    // Wrong role - redirect to correct dashboard
                    console.log('?? Wrong role - redirecting to correct dashboard');
                    const rolePaths = {
                        'admin': '/pages/admin/admin.html',
                        'operations_officer': '/pages/operations-officer/operations-officer.html',
                        'technician': '/pages/technician/technician.html',
                        'institution_user': '/pages/institution_user/institution_user.html'
                    };
                    const targetPath = rolePaths[user.role] || '/pages/login.html';
                    sessionStorage.setItem('redirecting_to_login', 'true');
                    window.location.replace(targetPath);
                    return;
                }
            } catch (e) {
                // Invalid user data - redirect to login
                console.log('?? Invalid user data - redirecting to login');
                sessionStorage.setItem('redirecting_to_login', 'true');
                window.location.replace('/pages/login.html');
                return;
            }
        })();
    </script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Dropdown Menu Styles */
        .dropdown-toggle .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .dropdown-menu {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            opacity: 0;
        }
        
        .dropdown-menu:not(.hidden) {
            max-height: 500px;
            opacity: 1;
            transition: max-height 0.5s ease-in, opacity 0.3s ease-in;
        }
        
        .sidenav-item.active {
            background-color: rgba(31, 41, 55, var(--tw-bg-opacity));
            color: white;
            border-left: 3px solid #3b82f6;
            padding-left: calc(1rem - 3px);
        }
        
        /* Pending Approval Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes bounceOnce {
            0%, 100% {
                transform: translateY(0);
            }
            25% {
                transform: translateY(-10px);
            }
            50% {
                transform: translateY(0);
            }
            75% {
                transform: translateY(-5px);
            }
        }

        .animate-bounce-once {
            animation: bounceOnce 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Pending Approval Modal (Hidden by default) -->
    <div id="pendingApprovalModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-95 flex items-center justify-center">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center animate-fade-in">
            <!-- Icon -->
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-yellow-100 mb-6">
                <i class="fas fa-clock text-yellow-600 text-4xl"></i>
            </div>
            
            <!-- Title -->
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Account Pending Approval</h2>
            
            <!-- Message -->
            <div class="mb-6">
                <p class="text-gray-600 mb-4">
                    Your Institution Admin account is currently pending approval from the administrator.
                </p>
                <p class="text-gray-600 mb-4">
                    You will receive a notification once your account has been reviewed and approved.
                </p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Please check your email regularly for updates.
                    </p>
                </div>
            </div>
            
            <!-- Status Badge -->
            <div class="mb-6">
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                    <span class="w-2 h-2 mr-2 bg-yellow-600 rounded-full animate-pulse"></span>
                    Status: Pending
                </span>
            </div>
            
            <!-- Logout Button -->
            <button id="pendingLogoutBtn" onclick="handlePendingLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                <i class="fas fa-sign-out-alt mr-2"></i>
                Logout
            </button>
            
            <!-- Support Contact -->
            <div class="mt-6 text-sm text-gray-500">
                <p>Need help? Contact administrator at</p>
                <a href="mailto:servieceeaseph@gmail.com" class="text-blue-600 hover:text-blue-800 font-medium">
                    serviceeaseph@gmail.com
                </a>
            </div>
        </div>
    </div>

    <!-- Approved Account Modal (Hidden by default) -->
    <div id="approvedAccountModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-95 flex items-center justify-center">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 text-center animate-fade-in">
            <!-- Success Icon with Animation -->
            <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6 animate-bounce-once">
                <i class="fas fa-check-circle text-green-600 text-5xl"></i>
            </div>
            
            <!-- Title -->
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Account Approved! ??</h2>
            
            <!-- Message -->
            <div class="mb-6">
                <p class="text-gray-600 mb-4">
                    Congratulations! Your Institution Admin account has been approved by the administrator.
                </p>
                <p class="text-gray-600 mb-4">
                    You now have full access to the ServiceEase Institution Admin Portal.
                </p>
                
                <!-- Feature List -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mt-4 text-left">
                    <p class="text-sm font-semibold text-gray-800 mb-2">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        You can now:
                    </p>
                    <ul class="text-sm text-gray-700 space-y-1">
                        <li><i class="fas fa-check text-green-600 mr-2"></i>Submit service requests</li>
                        <li><i class="fas fa-check text-green-600 mr-2"></i>Manage your printers</li>
                        <li><i class="fas fa-check text-green-600 mr-2"></i>Track service progress</li>
                        <li><i class="fas fa-check text-green-600 mr-2"></i>Manage institution users</li>
                    </ul>
                </div>
            </div>
            
            <!-- Status Badge -->
            <div class="mb-6">
                <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <span class="w-2 h-2 mr-2 bg-green-600 rounded-full"></span>
                    Status: Approved
                </span>
            </div>
            
            <!-- Continue Button -->
            <button id="approvedContinueBtn" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-lg">
                <i class="fas fa-arrow-right mr-2"></i>
                Continue to Dashboard
            </button>
            
            <!-- Welcome Note -->
            <div class="mt-6 text-sm text-gray-500">
                <p>Welcome to ServiceEase! ??</p>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Container -->
        <div id="sidebar-container" class="flex-shrink-0 w-64 bg-gray-900 text-white">
            <!-- The dynamic sidebar will be loaded here via institution-admin-sidenav.js -->
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Unified Header -->
            <div id="institution-admin-header-container"></div>

            <!-- Main Dashboard Content -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Total Printers -->
                    <div class="bg-white rounded-lg shadow-lg p-8 border-t-4 border-green-500 hover:shadow-xl transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Printers</p>
                                <p id="total-printers-count" class="text-4xl font-bold text-gray-800 mt-2">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </p>
                                <p class="text-sm text-gray-600 mt-2">Printers managed by your institution</p>
                            </div>
                            <div class="p-4 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-print text-4xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Users -->
                    <div class="bg-white rounded-lg shadow-lg p-8 border-t-4 border-purple-500 hover:shadow-xl transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase tracking-wide">Institution Users</p>
                                <p id="total-users-count" class="text-4xl font-bold text-gray-800 mt-2">
                                    <i class="fas fa-spinner fa-spin text-gray-400"></i>
                                </p>
                                <p class="text-sm text-gray-600 mt-2">Active users in your institution</p>
                            </div>
                            <div class="p-4 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-users text-4xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Welcome Message -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-lg p-8 text-white">
                    <h2 class="text-2xl font-bold mb-2">Welcome to Your Dashboard</h2>
                    <p class="text-blue-100">Here you can manage your institution's printers and users. Use the sidebar to navigate to different sections.</p>
                </div>
                
                <!-- Feature Pages (initially hidden) -->
                <div id="page-container" class="mt-8 hidden">
                    <!-- Service Requests Page -->
                    <div id="service-requests-page" class="page-content hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b flex justify-between items-center">
                                <h2 class="text-lg font-semibold text-gray-800">Service Request Management</h2>
                                <button id="new-service-request-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>New Request
                                </button>
                            </div>
                            <div class="p-6">
                                <!-- Filter Controls -->
                                <div class="mb-6 flex flex-wrap gap-4">
                                    <div class="w-full md:w-64">
                                        <input type="text" id="searchInput" placeholder="Search requests..." class="w-full px-4 py-2 border rounded-md">
                                    </div>
                                    <div class="w-full md:w-48">
                                        <select id="statusFilter" class="w-full px-4 py-2 border rounded-md">
                                            <option value="">All Statuses</option>
                                            <option value="new">New</option>
                                            <option value="in_progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                            <option value="issue">Issue</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-48">
                                        <select id="serviceTypeFilter" class="w-full px-4 py-2 border rounded-md">
                                            <option value="">All Types</option>
                                            <option value="repair">Repair</option>
                                            <option value="maintenance">Maintenance</option>
                                            <option value="installation">Installation</option>
                                        </select>
                                    </div>
                                    <div class="flex-grow text-right">
                                        <button id="refreshBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md">
                                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Stats Bar -->
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                                        <div class="text-center">
                                            <p class="text-sm text-gray-600">New</p>
                                            <p id="newRequests" class="text-xl font-bold text-blue-600">0</p>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-4">
                                        <div class="text-center">
                                            <p class="text-sm text-gray-600">In Progress</p>
                                            <p id="inProgressRequests" class="text-xl font-bold text-yellow-600">0</p>
                                        </div>
                                    </div>
                                    <div class="bg-green-50 border border-green-100 rounded-lg p-4">
                                        <div class="text-center">
                                            <p class="text-sm text-gray-600">Completed</p>
                                            <p id="completedRequests" class="text-xl font-bold text-green-600">0</p>
                                        </div>
                                    </div>
                                    <div class="bg-red-50 border border-red-100 rounded-lg p-4">
                                        <div class="text-center">
                                            <p class="text-sm text-gray-600">Issues</p>
                                            <p id="issueRequests" class="text-xl font-bold text-red-600">0</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Service Request Cards -->
                                <div id="loadingState" class="py-16 text-center">
                                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                                    <p class="text-gray-500">Loading service requests...</p>
                                </div>
                                
                                <div id="emptyState" class="py-16 text-center hidden">
                                    <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-3"></i>
                                    <p class="text-lg text-gray-500">No service requests found</p>
                                    <p class="text-gray-400">Try adjusting your filters or create a new request</p>
                                </div>
                                
                                <div id="requestsContainer" class="space-y-4 hidden">
                                    <!-- Service request cards will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Printer Management Page -->
                    <div id="printer-management-page" class="page-content hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b flex justify-between items-center">
                                <h2 class="text-lg font-semibold text-gray-800">Printer Management</h2>
                                <!-- Add Printer action removed per UI update -->
                            </div>
                            <div class="p-6">
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Institution</label>
                                    <select id="institutionSelect" class="w-full md:w-64 px-4 py-2 border rounded-md">
                                        <option value="">Select a client</option>
                                    </select>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <div class="inline-block min-w-full align-middle">
                                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Printer Name</th>
                                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Model</th>
                                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Serial Number</th>
                                                        <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="printersTbody" class="bg-white divide-y divide-gray-200">
                                                    <!-- Printer rows will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="emptyState" class="py-8 text-center text-gray-500 hidden">
                                            No printers found
                                        </div>
                                        <div class="mt-4 text-sm text-gray-500 flex items-center justify-between">
                                            <span id="totalCount"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Page -->
                    <div id="user-management-page" class="page-content hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b flex justify-between items-center">
                                <h2 class="text-lg font-semibold text-gray-800">User Management</h2>
                                <button id="add-user-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-user-plus mr-2"></i>Add User
                                </button>
                            </div>
                            <div class="p-6">
                                <!-- User Search -->
                                <div class="mb-6 flex flex-wrap gap-4">
                                    <div class="w-full md:w-64">
                                        <input type="text" id="userSearchInput" placeholder="Search users..." class="w-full px-4 py-2 border rounded-md">
                                    </div>
                                    <div class="w-full md:w-48">
                                        <select id="userRoleFilter" class="w-full px-4 py-2 border rounded-md">
                                            <option value="">All Roles</option>
                                            <option value="staff">Staff</option>
                                            <option value="manager">Manager</option>
                                        </select>
                                    </div>
                                    <div class="flex-grow text-right">
                                        <button id="refreshUsersBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-md">
                                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Users Table -->
                                <div class="overflow-x-auto">
                                    <div class="inline-block min-w-full align-middle">
                                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="usersTbody" class="bg-white divide-y divide-gray-200">
                                                    <!-- User rows will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="usersEmptyState" class="py-8 text-center text-gray-500 hidden">
                                            No users found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Reports Page -->
                    <div id="service-reports-page" class="page-content hidden">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b">
                                <h2 class="text-lg font-semibold text-gray-800">Service Analytics & Reports</h2>
                            </div>
                            <div class="p-6">
                                <!-- Report Controls -->
                                <div class="mb-6 flex flex-wrap gap-4">
                                    <div class="w-full md:w-64">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                        <select id="reportType" class="w-full px-4 py-2 border rounded-md">
                                            <option value="service_summary">Service Summary</option>
                                            <option value="printer_performance">Printer Performance</option>
                                            <option value="cost_analysis">Cost Analysis</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-64">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                        <select id="dateRange" class="w-full px-4 py-2 border rounded-md">
                                            <option value="last_30">Last 30 Days</option>
                                            <option value="last_90">Last 90 Days</option>
                                            <option value="year_to_date">Year to Date</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                    <div class="flex-grow text-right self-end">
                                        <button id="generateReport" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                            <i class="fas fa-chart-bar mr-2"></i>Generate Report
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Report Visualization Area -->
                                <div id="report-visualization" class="border rounded-lg p-4 bg-gray-50 mb-6 min-h-[20rem]">
                                    <div class="flex items-center justify-center h-full">
                                        <div class="text-center">
                                            <i class="fas fa-chart-pie text-5xl text-gray-300 mb-3"></i>
                                            <p class="text-gray-500">Select report parameters and generate a report</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Report Export Options -->
                                <div class="flex justify-end space-x-3">
                                    <button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" disabled>
                                        <i class="fas fa-file-pdf mr-2"></i>Export as PDF
                                    </button>
                                    <button class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" disabled>
                                        <i class="fas fa-file-excel mr-2"></i>Export as Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Service Request Detail Modal -->
    <div id="requestModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-lg font-semibold text-gray-800">Service Request Details</h3>
                <button id="closeRequestModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="requestModalContent" class="p-6">
                <!-- Request details will be loaded here -->
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3 sticky bottom-0">
                <button id="updateStatusBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Update Status
                </button>
                <button id="closeModalBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Update Service Status</h3>
            </div>
            <div class="p-6">
                <form id="statusUpdateForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Status</label>
                        <select id="newStatus" class="w-full px-4 py-2 border rounded-md">
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="issue">Issue Detected</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="statusNotes" class="w-full px-4 py-2 border rounded-md h-32" placeholder="Enter additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
                <button id="submitStatusUpdate" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Update
                </button>
                <button id="cancelStatusUpdate" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Add New User</h3>
            </div>
            <div class="p-6">
                <form id="addUserForm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                            <input type="text" id="firstName" class="w-full px-4 py-2 border rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                            <input type="text" id="lastName" class="w-full px-4 py-2 border rounded-md" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="userEmail" class="w-full px-4 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="userRole" class="w-full px-4 py-2 border rounded-md">
                            <option value="staff">Staff</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
                <button id="submitAddUser" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Add User
                </button>
                <button id="cancelAddUser" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">Change User Password</h3>
            </div>
            <div class="p-6">
                <form id="changePasswordForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                        <p id="passwordChangeUserName" class="text-gray-900 font-medium">-</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-2 border rounded-md" placeholder="Enter new password (min 6 characters)" required minlength="6">
                        <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border rounded-md" placeholder="Confirm new password" required minlength="6">
                    </div>
                    <div id="passwordError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                        <p class="text-sm text-red-600"></p>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-3">
                <button id="submitChangePassword" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Change Password
                </button>
                <button id="cancelChangePassword" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Notification Center -->
    <div id="notification-center" class="fixed inset-y-0 right-0 max-w-sm w-full bg-white shadow-lg z-40 transform translate-x-full transition-transform duration-300">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">Notifications</h3>
            <button id="close-notifications" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="notification-list" class="p-4 overflow-y-auto h-[calc(100%-4rem)]">
            <!-- Notifications will be loaded here -->
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-bell-slash text-4xl mb-3"></i>
                <p>No new notifications</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global logout handler for pending approval modal
        function handlePendingLogout() {
            console.log('handlePendingLogout called');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            console.log('LocalStorage cleared, redirecting...');
            window.location.href = '/pages/login.html';
        }
        
        // Add debug information to help diagnose loading issues
        console.log('Current page location:', window.location.href);
        console.log('Base URL:', window.location.origin);
        
        // Error handling for script loading
        window.addEventListener('error', function(e) {
            console.error('Script error detected:', e.message, e.filename, e.lineno);
            
            // Show fallback sidenav if script loading fails
            if (e.filename && e.filename.includes('institution-admin-sidenav.js')) {
                console.error('Error loading sidenav script, using fallback');
                document.getElementById('sidebar-container').classList.add('script-load-error');
            }
        }, true);
    </script>
    <script src="../../js/logout-confirm.js"></script>
    <script src="../../js/dynamic-sidebar-loader.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/institution-admin-header-loader.js"></script>
    <script src="../../js/institution-admin-ui.js" type="module"></script>
    <script src="../../js/institution-admin-sidenav.js"></script>
    <script src="../../js/client-service-management.js"></script>
    
    <!-- Fallback script if main script fails -->
    <script>
        // Check if sidenav was loaded successfully
        setTimeout(function() {
            const sidebarContainer = document.getElementById('sidebar-container');
            if (sidebarContainer && !sidebarContainer.querySelector('.institution-admin-sidenav') && sidebarContainer.children.length === 0) {
                console.log('Sidenav not found after timeout, using inline fallback');
                
                sidebarContainer.innerHTML = `
                    <div class="h-full flex flex-col p-4">
                        <div class="bg-red-100 text-red-700 p-4 rounded-lg mb-4">
                            <h3 class="font-bold">Navigation Loading Error</h3>
                            <p class="text-sm mt-1">The sidebar navigation couldn't be loaded.</p>
                            <button onclick="location.reload()" class="mt-2 px-4 py-1 bg-red-600 text-white rounded text-xs">
                                Reload Page
                            </button>
                        </div>
                        <div class="px-6 py-6 flex items-center border-b border-gray-800">
                            <div class="w-10 h-10 flex-shrink-0 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                                <i class="fas fa-cogs text-white"></i>
                            </div>
                            <div class="ml-3">
                                <h1 class="text-lg font-bold text-white">ServiceEase</h1>
                                <p class="text-xs text-gray-400">Institution Admin Portal</p>
                            </div>
                        </div>
                        <nav class="mt-6 px-4 flex-1">
                            <a href="#" class="block px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-800 hover:text-white transition-colors mb-3">Dashboard</a>
                            <a href="#service-requests" class="block px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-800 hover:text-white transition-colors mb-3">Service Requests</a>
                            <a href="#printer-management" class="block px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-800 hover:text-white transition-colors mb-3">Printer Management</a>
                            <a href="#user-management" class="block px-4 py-3 text-gray-300 rounded-lg hover:bg-gray-800 hover:text-white transition-colors mb-3">User Management</a>
                        </nav>
                    </div>
                `;
            }
        }, 2000);
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load unified institution admin header
            if (window.loadInstitutionAdminHeader) {
                window.loadInstitutionAdminHeader({
                    title: 'Institution Admin Dashboard',
                    subtitle: 'Overview and statistics'
                });
            }
            
            // Initialize user data
            const user = JSON.parse(localStorage.getItem('user')) || { first_name: 'Institution Admin', last_name: 'User' };
            
            // Check approval status
            checkApprovalStatus();
            
            async function checkApprovalStatus() {
                try {
                    const token = localStorage.getItem('token');
                    const user = JSON.parse(localStorage.getItem('user'));
                    
                    if (!token || !user) {
                        window.location.href = '/pages/login.html';
                        return;
                    }
                    
                    // Fetch current user data to check approval status
                    const response = await fetch('/api/user/profile', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        console.log('User approval status:', userData.approval_status);
                        
                        // Check if approval_status is pending
                        if (userData.approval_status === 'pending') {
                            console.log('Showing pending approval modal');
                            // Show the pending approval modal
                            const modal = document.getElementById('pendingApprovalModal');
                            if (modal) {
                                modal.classList.remove('hidden');
                                console.log('Modal shown, checking for logout button...');
                                
                                const logoutBtn = document.getElementById('pendingLogoutBtn');
                                console.log('Logout button found:', logoutBtn);
                            } else {
                                console.error('pendingApprovalModal not found in DOM');
                            }
                        } else if (userData.approval_status === 'approved') {
                            // Check if this is the first time seeing the approved status
                            const hasSeenApprovalModal = localStorage.getItem('hasSeenApprovalModal');
                            
                            if (!hasSeenApprovalModal) {
                                // Show the approved account modal
                                document.getElementById('approvedAccountModal').classList.remove('hidden');
                                
                                // Setup continue button
                                document.getElementById('approvedContinueBtn').addEventListener('click', function() {
                                    // Mark that user has seen the approval modal
                                    localStorage.setItem('hasSeenApprovalModal', 'true');
                                    // Hide the modal
                                    document.getElementById('approvedAccountModal').classList.add('hidden');
                                });
                            }
                        }
                    } else if (response.status === 401) {
                        // Token expired or invalid
                        window.location.href = '/pages/login.html';
                    }
                } catch (error) {
                    console.error('Error checking approval status:', error);
                }
            }
            
            // Navigation
            const navLinks = {
                '#service-requests': 'service-requests-page',
                '#printer-management': 'printer-management-page',
                '#user-management': 'user-management-page',
                '#service-reports': 'service-reports-page',
                '#add-printer': 'printer-management-page',
                '#add-user': 'user-management-page',
                '#new-service-request': 'service-requests-page'
            };
            
            for (const link in navLinks) {
                document.querySelectorAll(`a[href="${link}"]`).forEach(el => {
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(navLinks[link]);
                        
                        // Special actions for quick links
                        if (link === '#new-service-request') {
                            document.getElementById('newRequestModal').classList.remove('hidden');
                        } else if (link === '#add-printer') {
                            // Add Printer quick link removed - open printer management page instead
                            document.getElementById('printer-management-page')?.classList.remove('hidden');
                        } else if (link === '#add-user') {
                            document.getElementById('addUserModal').classList.remove('hidden');
                        }
                    });
                });
            }
            
            // Show a specific page
            function showPage(pageId) {
                const pageContainer = document.getElementById('page-container');
                pageContainer.classList.remove('hidden');
                
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('hidden');
                });
                
                // Show requested page
                document.getElementById(pageId).classList.remove('hidden');
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
            
            // Notification Center Toggle
            const notificationsButton = document.getElementById('notifications-button');
            if (notificationsButton) {
                notificationsButton.addEventListener('click', () => {
                    const notificationCenter = document.getElementById('notification-center');
                    if (notificationCenter) {
                        notificationCenter.classList.toggle('translate-x-full');
                        notificationCenter.classList.toggle('translate-x-0');
                    }
                });
            }
            
            const closeNotifications = document.getElementById('close-notifications');
            if (closeNotifications) {
                closeNotifications.addEventListener('click', () => {
                    const notificationCenter = document.getElementById('notification-center');
                    if (notificationCenter) {
                        notificationCenter.classList.add('translate-x-full');
                        notificationCenter.classList.remove('translate-x-0');
                    }
                });
            }
            
            // Modal Controls
            document.getElementById('new-service-request-btn')?.addEventListener('click', () => {
                document.getElementById('newRequestModal').classList.remove('hidden');
            });
            
            document.getElementById('add-user-btn')?.addEventListener('click', () => {
                document.getElementById('addUserModal').classList.remove('hidden');
            });
            
            // Close all modals when clicking outside
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Cancel buttons for modals
            document.getElementById('cancelNewRequest')?.addEventListener('click', () => {
                document.getElementById('newRequestModal').classList.add('hidden');
            });
            
            document.getElementById('cancelAddUser')?.addEventListener('click', () => {
                document.getElementById('addUserModal').classList.add('hidden');
            });
            
            document.getElementById('cancelChangePassword')?.addEventListener('click', () => {
                document.getElementById('changePasswordModal').classList.add('hidden');
            });
            
            document.getElementById('submitChangePassword')?.addEventListener('click', async () => {
                // This calls the function from institution-admin-ui.js
                if (typeof submitPasswordChange === 'function') {
                    await submitPasswordChange();
                }
            });
            
            // Form submissions
            document.getElementById('submitNewRequest')?.addEventListener('click', async () => {
                // Form submission logic would go here
                document.getElementById('newRequestModal').classList.add('hidden');
                // Show success notification
                showNotification('Success', 'Service request submitted successfully', 'success');
            });
            
            document.getElementById('submitAddUser')?.addEventListener('click', async () => {
                // Form submission logic would go here
                document.getElementById('addUserModal').classList.add('hidden');
                // Show success notification
                showNotification('Success', 'New user added successfully', 'success');
            });
            
            // Helper function to show notifications
            function showNotification(title, message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-100 border-green-500' : 
                               type === 'error' ? 'bg-red-100 border-red-500' : 
                               'bg-blue-100 border-blue-500';
                const textColor = type === 'success' ? 'text-green-700' : 
                                 type === 'error' ? 'text-red-700' : 
                                 'text-blue-700';
                const icon = type === 'success' ? 'fa-check-circle' : 
                           type === 'error' ? 'fa-exclamation-circle' : 
                           'fa-info-circle';
                
                toast.className = `fixed bottom-4 right-4 ${bgColor} border-l-4 p-4 rounded shadow-lg max-w-md z-50`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas ${icon} ${textColor}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium ${textColor}">${title}</p>
                            <p class="text-sm ${textColor} opacity-90">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 ${textColor}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>







