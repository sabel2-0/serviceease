<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password | ServiceEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Logo/Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-emerald-400 mb-2">ServiceEase</h1>
            <p class="text-slate-300">Change Your Password</p>
        </div>

        <!-- Change Password Card -->
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-8 border border-slate-700">
            <div class="mb-6">
                <div class="bg-amber-900/30 border border-amber-700 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-amber-400 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-amber-200">Security Required</p>
                            <p class="text-xs text-amber-300 mt-1">You must change your temporary password before accessing the system.</p>
                        </div>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold text-white mb-2">Create New Password</h2>
                <p class="text-slate-400 text-sm">Your new password must be at least 8 characters long and include letters, numbers, and symbols.</p>
            </div>

            <!-- Alert -->
            <div id="alert" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

            <!-- Form -->
            <form id="changePasswordForm" class="space-y-5">
                <!-- New Password -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword"
                            required
                            class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                            placeholder="Create a strong password">
                        <button type="button" id="toggleNewPassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Password Strength Indicator -->
                    <div class="mt-2">
                        <div class="flex gap-1 mb-1">
                            <div id="strength-bar-1" class="h-1 flex-1 rounded bg-slate-600 transition-all"></div>
                            <div id="strength-bar-2" class="h-1 flex-1 rounded bg-slate-600 transition-all"></div>
                            <div id="strength-bar-3" class="h-1 flex-1 rounded bg-slate-600 transition-all"></div>
                            <div id="strength-bar-4" class="h-1 flex-1 rounded bg-slate-600 transition-all"></div>
                        </div>
                        <p id="strength-text" class="text-xs text-slate-400">Password strength</p>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="mt-2 space-y-1">
                        <div id="req-length" class="flex items-center text-xs text-slate-400">
                            <i class="fas fa-circle w-3 mr-2 text-slate-600"></i>
                            <span>At least 8 characters</span>
                        </div>
                        <div id="req-letter" class="flex items-center text-xs text-slate-400">
                            <i class="fas fa-circle w-3 mr-2 text-slate-600"></i>
                            <span>Contains letters (a-z)</span>
                        </div>
                        <div id="req-number" class="flex items-center text-xs text-slate-400">
                            <i class="fas fa-circle w-3 mr-2 text-slate-600"></i>
                            <span>Contains numbers (0-9)</span>
                        </div>
                        <div id="req-special" class="flex items-center text-xs text-slate-400">
                            <i class="fas fa-circle w-3 mr-2 text-slate-600"></i>
                            <span>Contains symbols (!@#$%^&*)</span>
                        </div>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">
                        Confirm New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword"
                            required
                            class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                            placeholder="Re-enter your new password">
                        <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-xl">
                    <span id="submitBtnText">Change Password</span>
                    <i id="submitLoader" class="fas fa-circle-notch fa-spin ml-2 hidden"></i>
                </button>
            </form>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6">
            <p class="text-slate-400 text-sm">
                Need help? Contact your administrator
            </p>
        </div>
    </div>

    <script>
        // Get user data from URL params or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId') || localStorage.getItem('tempUserId');
        const userEmail = urlParams.get('email') || localStorage.getItem('tempUserEmail');
        const userRole = urlParams.get('role') || localStorage.getItem('tempUserRole');

        if (!userId || !userEmail) {
            window.location.href = '/client/src/pages/login.html';
        }

        // Toggle password visibility
        document.getElementById('toggleNewPassword').addEventListener('click', function() {
            const input = document.getElementById('newPassword');
            const icon = this.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });

        // Password strength checker
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            
            // Check requirements
            const hasLength = password.length >= 8;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            // Update requirement indicators
            updateRequirement('req-length', hasLength);
            updateRequirement('req-letter', hasLetter);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-special', hasSpecial);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength++;
            if (hasLetter) strength++;
            if (hasNumber) strength++;
            if (hasSpecial) strength++;
            
            // Update strength bars
            const bars = [
                document.getElementById('strength-bar-1'),
                document.getElementById('strength-bar-2'),
                document.getElementById('strength-bar-3'),
                document.getElementById('strength-bar-4')
            ];
            
            const strengthText = document.getElementById('strength-text');
            
            bars.forEach((bar, index) => {
                if (index < strength) {
                    if (strength === 1) {
                        bar.classList.remove('bg-slate-600', 'bg-yellow-500', 'bg-emerald-500');
                        bar.classList.add('bg-red-500');
                    } else if (strength === 2) {
                        bar.classList.remove('bg-slate-600', 'bg-red-500', 'bg-emerald-500');
                        bar.classList.add('bg-orange-500');
                    } else if (strength === 3) {
                        bar.classList.remove('bg-slate-600', 'bg-red-500', 'bg-orange-500');
                        bar.classList.add('bg-yellow-500');
                    } else {
                        bar.classList.remove('bg-slate-600', 'bg-red-500', 'bg-orange-500', 'bg-yellow-500');
                        bar.classList.add('bg-emerald-500');
                    }
                } else {
                    bar.classList.remove('bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-emerald-500');
                    bar.classList.add('bg-slate-600');
                }
            });
            
            // Update strength text
            const strengthLabels = ['', 'Weak', 'Fair', 'Good', 'Strong'];
            const strengthColors = ['text-slate-400', 'text-red-400', 'text-orange-400', 'text-yellow-400', 'text-emerald-400'];
            
            strengthText.textContent = password.length > 0 ? strengthLabels[strength] : 'Password strength';
            strengthText.className = `text-xs ${password.length > 0 ? strengthColors[strength] : 'text-slate-400'}`;
        });
        
        function updateRequirement(id, isMet) {
            const element = document.getElementById(id);
            const icon = element.querySelector('i');
            const text = element.querySelector('span');
            
            if (isMet) {
                icon.className = 'fas fa-check-circle w-3 mr-2 text-emerald-400';
                text.className = 'text-emerald-400';
            } else {
                icon.className = 'fas fa-circle w-3 mr-2 text-slate-600';
                text.className = 'text-slate-400';
            }
        }

        document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
            const input = document.getElementById('confirmPassword');
            const icon = this.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });

        // Form submission
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const alertDiv = document.getElementById('alert');
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitLoader = document.getElementById('submitLoader');

            // Validation
            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters long', 'error');
                return;
            }

            const hasLetter = /[A-Za-z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);
            const hasSymbol = /[^A-Za-z0-9]/.test(newPassword);

            if (!hasLetter || !hasNumber || !hasSymbol) {
                showAlert('Password must include letters, numbers, and symbols', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.textContent = 'Changing...';
            submitLoader.classList.remove('hidden');

            try {
                const response = await fetch('/api/change-temporary-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to change password');
                }

                // Success - store token and user data
                localStorage.setItem('token', result.token);
                localStorage.setItem('user', JSON.stringify(result.user));
                
                // Clear temporary data
                localStorage.removeItem('tempUserId');
                localStorage.removeItem('tempUserEmail');
                localStorage.removeItem('tempUserRole');

                showAlert('Password changed successfully! Redirecting...', 'success');

                // Redirect based on role
                setTimeout(() => {
                    if (result.user.role === 'technician') {
                        window.location.href = '/client/src/pages/technician/technician.html';
                    } else if (result.user.role === 'operations_officer') {
                        window.location.href = '/client/src/pages/operations-officer/operations-officer.html';
                    } else {
                        window.location.href = '/client/src/pages/admin/admin.html';
                    }
                }, 1500);

            } catch (error) {
                console.error('Error changing password:', error);
                showAlert(error.message, 'error');
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Change Password';
                submitLoader.classList.add('hidden');
            }
        });

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.className = 'mb-4 p-3 rounded-lg text-sm ';
            
            if (type === 'error') {
                alertDiv.className += 'bg-red-900/30 border border-red-700 text-red-200';
            } else if (type === 'success') {
                alertDiv.className += 'bg-emerald-900/30 border border-emerald-700 text-emerald-200';
            }
            
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>





