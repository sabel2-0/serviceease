<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Coordinator Dashboard</title>
    
    <!-- AUTHENTICATION CHECK -->
    <script>
        (function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userStr = localStorage.getItem('user');
            
            if (!isLoggedIn || !userStr) {
                window.location.replace('/pages/login.html');
                return;
            }
            
            try {
                const user = JSON.parse(userStr);
                if (user.role !== 'coordinator') {
                    const rolePaths = {
                        'admin': '/pages/admin/admin.html',
                        'operations_officer': '/pages/operations-officer/operations-officer.html',
                        'technician': '/pages/technician/technician.html',
                        'requester': '/pages/requester/requester.html'
                    };
                    const targetPath = rolePaths[user.role] || '/pages/login.html';
                    window.location.replace(targetPath);
                    return;
                }
            } catch (e) {
                window.location.replace('/pages/login.html');
                return;
            }
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .notification-item {
            transition: all 0.3s ease;
        }
        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .notification-unread {
            background-color: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        .notification-read {
            background-color: #f9fafb;
            opacity: 0.8;
        }
        .notification-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 20px;
        }
        .icon-printer { background-color: #dbeafe; color: #1e40af; }
        .icon-service { background-color: #fef3c7; color: #d97706; }
        .icon-completed { background-color: #d1fae5; color: #059669; }
        .icon-pending { background-color: #fee2e2; color: #dc2626; }
        .icon-info { background-color: #e0e7ff; color: #4f46e5; }
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-new { background-color: #3b82f6; color: white; }
        .badge-pending { background-color: #eab308; color: white; }
        .badge-completed { background-color: #10b981; color: white; }
        .badge-assigned { background-color: #8b5cf6; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar Container -->
    <div id="sidebar-container">
        <!-- The dynamic sidebar will be loaded here via coordinator-sidenav.js -->
    </div>

    <div class="ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-bell mr-2 text-blue-600"></i>
                            Notifications
                        </h1>
                        <p class="text-sm text-gray-600 mt-1">
                            Stay updated with printer assignments and service requests
                        </p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="markAllReadBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-check-double mr-2"></i>
                            Mark All Read
                        </button>
                        <button id="refreshBtn" class="p-2 text-gray-600 hover:text-blue-600 transition-colors">
                            <i class="fas fa-sync-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Filters -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-wrap gap-3">
                    <button class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-filter="all">
                        <i class="fas fa-th mr-2"></i>All
                    </button>
                    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-filter="unread">
                        <i class="fas fa-envelope mr-2"></i>Unread
                    </button>
                    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-filter="printer_assigned">
                        <i class="fas fa-print mr-2"></i>Printer Assignments
                    </button>
                    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-filter="service_request">
                        <i class="fas fa-tools mr-2"></i>Service Requests
                    </button>
                    <button class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-filter="completed">
                        <i class="fas fa-check-circle mr-2"></i>Completed
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Unread</p>
                            <p class="text-2xl font-bold text-blue-600" id="unreadCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-envelope text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Printers</p>
                            <p class="text-2xl font-bold text-purple-600" id="printerCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-print text-purple-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Services</p>
                            <p class="text-2xl font-bold text-amber-600" id="serviceCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-wrench text-amber-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Completed</p>
                            <p class="text-2xl font-bold text-green-600" id="completedCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications List -->
            <div class="bg-white rounded-lg shadow-sm">
                <div id="notificationsList" class="divide-y divide-gray-200">
                    <!-- Notifications will be loaded here -->
                </div>
                <div id="emptyState" class="p-12 text-center hidden">
                    <i class="fas fa-bell-slash text-gray-300 text-6xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No notifications</h3>
                    <p class="text-gray-600">You're all caught up!</p>
                </div>
                <div id="loadingState" class="p-12 text-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 text-4xl mb-4"></i>
                    <p class="text-gray-600">Loading notifications...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Coordinator Sidenav -->
    <script src="../../js/coordinator-sidenav.js"></script>

    <script>
        let allNotifications = [];
        let currentFilter = 'all';
        let isInitialized = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for sidenav to load
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await loadNotifications();
            setupEventListeners();
            isInitialized = true;
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (isInitialized) {
                    loadNotifications();
                }
            }, 30000);
        });

        // Load notifications from API
        async function loadNotifications() {
            try {
                const loadingState = document.getElementById('loadingState');
                const notificationsList = document.getElementById('notificationsList');
                const emptyState = document.getElementById('emptyState');
                
                // Show loading state
                if (loadingState) loadingState.classList.remove('hidden');
                if (emptyState) emptyState.classList.add('hidden');
                
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load notifications');

                const data = await response.json();
                allNotifications = data.notifications || [];
                
                console.log('Loaded notifications:', allNotifications.length);
                
                updateStatistics();
                renderNotifications();
                
                if (loadingState) loadingState.classList.add('hidden');
            } catch (error) {
                console.error('Error loading notifications:', error);
                const loadingState = document.getElementById('loadingState');
                if (loadingState) loadingState.classList.add('hidden');
                showToast('Error', 'Failed to load notifications', 'error');
            }
        }

        // Update statistics
        function updateStatistics() {
            const unread = allNotifications.filter(n => !n.is_read).length;
            const printerNotifs = allNotifications.filter(n => 
                n.reference_type === 'inventory_item' || n.message.toLowerCase().includes('printer')
            ).length;
            const serviceNotifs = allNotifications.filter(n => 
                n.type === 'service_request' || n.reference_type === 'service_request'
            ).length;
            const completedNotifs = allNotifications.filter(n => 
                n.message && (n.message.includes('completed') || n.message.includes('Completed'))
            ).length;

            document.getElementById('unreadCount').textContent = unread;
            document.getElementById('printerCount').textContent = printerNotifs;
            document.getElementById('serviceCount').textContent = serviceNotifs;
            document.getElementById('completedCount').textContent = completedNotifs;
        }

        // Render notifications based on current filter
        function renderNotifications() {
            let filtered = allNotifications;

            switch(currentFilter) {
                case 'unread':
                    filtered = allNotifications.filter(n => !n.is_read);
                    break;
                case 'printer_assigned':
                    filtered = allNotifications.filter(n => 
                        n.reference_type === 'inventory_item' || n.message.toLowerCase().includes('printer')
                    );
                    break;
                case 'service_request':
                    filtered = allNotifications.filter(n => 
                        n.type === 'service_request' || n.reference_type === 'service_request'
                    );
                    break;
                case 'completed':
                    filtered = allNotifications.filter(n => 
                        n.message && (n.message.includes('completed') || n.message.includes('Completed'))
                    );
                    break;
            }

            const container = document.getElementById('notificationsList');
            const emptyState = document.getElementById('emptyState');

            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filtered.map(notif => createNotificationHTML(notif)).join('');
        }

        // Create HTML for a notification
        function createNotificationHTML(notif) {
            const isRead = notif.is_read;
            const date = new Date(notif.created_at);
            const timeAgo = getTimeAgo(date);
            
            // Determine icon and style based on notification type
            let iconClass = 'icon-info';
            let icon = 'fa-info-circle';
            
            if (notif.reference_type === 'inventory_item' || notif.message.toLowerCase().includes('printer')) {
                iconClass = 'icon-printer';
                icon = 'fa-print';
            } else if (notif.type === 'service_request' || notif.reference_type === 'service_request') {
                if (notif.message.includes('completed') || notif.message.includes('Completed')) {
                    iconClass = 'icon-completed';
                    icon = 'fa-check-circle';
                } else if (notif.message.includes('pending') || notif.message.includes('assigned')) {
                    iconClass = 'icon-service';
                    icon = 'fa-wrench';
                }
            }

            const badge = getBadge(notif);
            const priorityColor = getPriorityColor(notif.priority);

            return `
                <div class="notification-item ${isRead ? 'notification-read' : 'notification-unread'} p-4 cursor-pointer" 
                     data-id="${notif.id}">
                    <div class="flex items-start space-x-4">
                        <div class="notification-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="text-sm font-semibold text-gray-900 mb-1">
                                        ${notif.title}
                                        ${!isRead ? '<span class="inline-block w-2 h-2 bg-blue-600 rounded-full ml-2"></span>' : ''}
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-2">${notif.message}</p>
                                    <div class="flex items-center space-x-3 text-xs text-gray-500">
                                        <span><i class="far fa-clock mr-1"></i>${timeAgo}</span>
                                        ${notif.sender_name ? `<span><i class="far fa-user mr-1"></i>${notif.sender_name}</span>` : ''}
                                        ${badge ? `<span class="badge ${badge.class}">${badge.text}</span>` : ''}
                                        ${notif.priority ? `<span class="px-2 py-1 rounded text-xs font-medium ${priorityColor}">${notif.priority.toUpperCase()}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    ${!isRead ? `
                                        <button class="mark-read-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" 
                                                data-id="${notif.id}" title="Mark as read">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    <button class="delete-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" 
                                            data-id="${notif.id}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get badge info based on notification content
        function getBadge(notif) {
            if (notif.message.includes('assigned') && notif.reference_type === 'inventory_item') {
                return { text: 'Assigned', class: 'badge-assigned' };
            } else if (notif.message.includes('New') || notif.message.includes('new')) {
                return { text: 'New', class: 'badge-new' };
            } else if (notif.message.includes('pending')) {
                return { text: 'Pending', class: 'badge-pending' };
            } else if (notif.message.includes('completed') || notif.message.includes('Completed')) {
                return { text: 'Completed', class: 'badge-completed' };
            }
            return null;
        }

        // Get priority color
        function getPriorityColor(priority) {
            const colors = {
                'urgent': 'bg-red-100 text-red-800',
                'high': 'bg-orange-100 text-orange-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-gray-100 text-gray-800'
            };
            return colors[priority] || colors['medium'];
        }

        // Get time ago text
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            
            return date.toLocaleDateString();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active', 'bg-blue-600', 'text-white');
                        b.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    });
                    btn.classList.add('active', 'bg-blue-600', 'text-white');
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                    
                    currentFilter = btn.dataset.filter;
                    renderNotifications();
                });
            });

            // Mark all read button
            document.getElementById('markAllReadBtn').addEventListener('click', markAllAsRead);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                document.getElementById('refreshBtn').querySelector('i').classList.add('fa-spin');
                loadNotifications().finally(() => {
                    document.getElementById('refreshBtn').querySelector('i').classList.remove('fa-spin');
                });
            });

            // Delegated event listeners for notification actions
            document.getElementById('notificationsList').addEventListener('click', async (e) => {
                const btn = e.target.closest('.mark-read-btn, .delete-btn');
                if (!btn) return;

                e.stopPropagation();
                const notifId = btn.dataset.id;

                if (btn.classList.contains('mark-read-btn')) {
                    await markAsRead(notifId);
                } else if (btn.classList.contains('delete-btn')) {
                    await deleteNotification(notifId);
                }
            });
        }

        // Mark notification as read
        async function markAsRead(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/notifications/${id}/read`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to mark as read');

                await loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showToast('Error', 'Failed to mark notification as read', 'error');
            }
        }

        // Mark all notifications as read
        async function markAllAsRead() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/notifications/read-all', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to mark all as read');

                showToast('Success', 'All notifications marked as read', 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error marking all as read:', error);
                showToast('Error', 'Failed to mark all as read', 'error');
            }
        }

        // Delete notification
        async function deleteNotification(id) {
            if (!confirm('Are you sure you want to delete this notification?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/notifications/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete notification');

                showToast('Success', 'Notification deleted', 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error deleting notification:', error);
                showToast('Error', 'Failed to delete notification', 'error');
            }
        }

        // Show toast notification
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-100 border-green-500' : 
                           type === 'error' ? 'bg-red-100 border-red-500' : 
                           'bg-blue-100 border-blue-500';
            const textColor = type === 'success' ? 'text-green-700' : 
                             type === 'error' ? 'text-red-700' : 
                             'text-blue-700';
            const icon = type === 'success' ? 'fa-check-circle' : 
                       type === 'error' ? 'fa-exclamation-circle' : 
                       'fa-info-circle';
            
            toast.className = `fixed bottom-4 right-4 ${bgColor} border-l-4 p-4 rounded shadow-lg max-w-md z-50`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas ${icon} ${textColor}"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium ${textColor}">${title}</p>
                        <p class="text-sm ${textColor} opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 ${textColor}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 5000);
        }

        // Add filter button styling
        document.querySelectorAll('.filter-btn').forEach((btn, index) => {
            if (index === 0) {
                btn.classList.add('bg-blue-600', 'text-white');
            } else {
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            }
        });
    </script>
</body>
</html>
