<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | ServiceEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .bg-image {
            background-image: url('../images/img-art-left.jpg');
            background-size: cover;
            background-position: center;
        }
        
        .password-strength-bar {
            height: 4px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .strength-weak { 
            background-color: #ef4444; 
            width: 33%;
        }
        
        .strength-medium { 
            background-color: #f59e0b; 
            width: 66%;
        }
        
        .strength-strong { 
            background-color: #10b981; 
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen bg-white">
    <div class="min-h-screen flex">
        <!-- Left side - Minimalist Image Section -->
        <div class="hidden lg:flex lg:w-1/2 items-center justify-center bg-gray-50">
            <div class="text-center">
                <div class="w-80 h-80 mx-auto mb-8 bg-image rounded-lg shadow-sm"></div>
                <h1 class="text-4xl font-light tracking-tight text-gray-900 mb-2">ServiceEase</h1>
                <p class="text-gray-500 text-base font-light">Efficient Service Management</p>
            </div>
        </div>

        <!-- Right side - Reset Password Form -->
        <div class="w-full lg:w-1/2 flex flex-col">
            <!-- Mobile Brand Header -->
            <div class="lg:hidden p-6 text-center border-b border-gray-100">
                <h1 class="text-2xl font-light text-gray-900">ServiceEase</h1>
            </div>
            
            <!-- Form Container -->
            <div class="flex-1 flex items-center justify-center p-6 lg:p-12">
                <div class="w-full max-w-md lg:max-w-lg">
                    <!-- Loading state -->
                    <div id="loadingState" class="text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Verifying reset link...</p>
                    </div>

                    <!-- Invalid/Expired token state -->
                    <div id="invalidTokenState" class="hidden text-center">
                        <div class="mb-6">
                            <i class="fas fa-times-circle text-5xl text-red-400"></i>
                        </div>
                        <h2 class="text-3xl font-light text-gray-900 mb-3">Invalid or Expired Link</h2>
                        <p class="text-gray-600 mb-6">
                            This password reset link is invalid or has expired. Reset links are only valid for 1 hour.
                        </p>
                        <a href="forgot-password.html" 
                            class="inline-block py-3 px-6 border border-transparent rounded-md text-base
                            text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2
                            focus:ring-offset-2 focus:ring-gray-900 transition-all">
                            Request New Link
                        </a>
                    </div>

                    <!-- Reset password form -->
                    <div id="resetFormState" class="hidden">
                        <div class="mb-10 text-center lg:text-left">
                            <h2 class="text-4xl lg:text-5xl font-light text-gray-900 mb-3">Create New Password</h2>
                            <p class="text-base lg:text-lg text-gray-600 font-light">
                                Resetting password for <span id="userEmail" class="font-medium text-gray-900"></span>
                            </p>
                        </div>

                        <!-- Error Message -->
                        <div id="errorMessage" class="hidden mb-6 p-3 bg-red-50 border border-red-100 rounded-md">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-circle text-red-400 text-sm mr-2"></i>
                                    <p id="errorText" class="text-xs text-red-700"></p>
                                </div>
                                <button type="button" onclick="hideError()" class="text-red-400 hover:text-red-600 ml-2">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <form id="resetPasswordForm" class="space-y-5">
                            <!-- New Password Input -->
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-600 mb-2">New Password</label>
                                <div class="relative">
                                    <input type="password" id="newPassword" name="newPassword" required
                                        class="block w-full px-4 py-3 border border-gray-200 rounded-md text-base text-gray-900 
                                        focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900
                                        transition-all"
                                        placeholder="Enter new password"
                                        minlength="8">
                                    <button type="button" onclick="togglePasswordVisibility('newPassword')"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye text-sm"></i>
                                    </button>
                                </div>
                                <!-- Password Strength Indicator -->
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-1 overflow-hidden">
                                        <div id="strengthBar" class="password-strength-bar"></div>
                                    </div>
                                    <p id="strengthText" class="text-xs mt-1 text-gray-500"></p>
                                </div>
                                <p class="mt-1 text-xs text-gray-500">
                                    Must be at least 8 characters
                                </p>
                            </div>

                            <!-- Confirm Password Input -->
                            <div>
                                <label for="confirmPassword" class="block text-sm font-medium text-gray-600 mb-2">Confirm Password</label>
                                <div class="relative">
                                    <input type="password" id="confirmPassword" name="confirmPassword" required
                                        class="block w-full px-4 py-3 border border-gray-200 rounded-md text-base text-gray-900 
                                        focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900
                                        transition-all"
                                        placeholder="Confirm new password"
                                        minlength="8">
                                    <button type="button" onclick="togglePasswordVisibility('confirmPassword')"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-eye text-sm"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit"
                                class="w-full py-3 px-4 border border-transparent rounded-md text-base
                                text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2
                                focus:ring-offset-2 focus:ring-gray-900 transition-all">
                                <span id="submitBtnText">Reset Password</span>
                            </button>
                        </form>
                    </div>

                    <!-- Success state -->
                    <div id="successState" class="hidden text-center">
                        <div class="mb-6">
                            <i class="fas fa-check-circle text-5xl text-green-400"></i>
                        </div>
                        <h2 class="text-3xl font-light text-gray-900 mb-3">Password Reset Successful</h2>
                        <p class="text-gray-600 mb-6">
                            Your password has been successfully reset. You can now sign in with your new password.
                        </p>
                        <a href="login.html" 
                            class="inline-block py-3 px-6 border border-transparent rounded-md text-base
                            text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2
                            focus:ring-offset-2 focus:ring-gray-900 transition-all">
                            Sign In
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let resetToken = null;

        // Extract token from URL
        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        // Verify token on page load
        async function verifyToken() {
            resetToken = getTokenFromUrl();
            
            if (!resetToken) {
                showInvalidToken();
                return;
            }

            try {
                const response = await fetch(`/api/auth/verify-reset-token/${resetToken}`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('userEmail').textContent = data.email;
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('resetFormState').classList.remove('hidden');
                } else {
                    showInvalidToken();
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                showInvalidToken();
            }
        }

        function showInvalidToken() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('invalidTokenState').classList.remove('hidden');
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function calculatePasswordStrength(password) {
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;
            
            return strength;
        }

        function updatePasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            if (!password) {
                strengthBar.className = 'password-strength-bar';
                strengthText.textContent = '';
                return;
            }
            
            const strength = calculatePasswordStrength(password);
            
            strengthBar.className = 'password-strength-bar';
            
            if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Weak password';
                strengthText.className = 'text-xs mt-1 text-red-600';
            } else if (strength <= 3) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Medium password';
                strengthText.className = 'text-xs mt-1 text-yellow-600';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Strong password';
                strengthText.className = 'text-xs mt-1 text-green-600';
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            verifyToken();
            
            // Add password strength checker
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', updatePasswordStrength);
            }
        });

        // Handle form submission
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            hideError();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const submitBtnText = document.getElementById('submitBtnText');
            
            try {
                submitBtn.disabled = true;
                submitBtnText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting...';
                
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: resetToken,
                        newPassword: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success state
                    document.getElementById('resetFormState').classList.add('hidden');
                    document.getElementById('successState').classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'An error occurred. Please try again.');
                
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Reset Password';
            }
        });
    </script>
</body>
</html>





