<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test - ServiceEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
        <h1 class="text-2xl font-bold text-center mb-6">Authentication Test</h1>
        
        <div class="space-y-4">
            <div class="border p-4 rounded">
                <h3 class="font-semibold text-gray-700">Token Status:</h3>
                <p id="tokenStatus" class="text-sm text-gray-600">Checking...</p>
            </div>
            
            <div class="border p-4 rounded">
                <h3 class="font-semibold text-gray-700">User Data:</h3>
                <pre id="userData" class="text-sm text-gray-600 whitespace-pre-wrap">Checking...</pre>
            </div>
            
            <div class="border p-4 rounded">
                <h3 class="font-semibold text-gray-700">Token Payload:</h3>
                <pre id="tokenPayload" class="text-sm text-gray-600 whitespace-pre-wrap">Checking...</pre>
            </div>
            
            <div class="border p-4 rounded">
                <h3 class="font-semibold text-gray-700">API Test:</h3>
                <p id="apiTest" class="text-sm text-gray-600">Testing...</p>
                <button id="testApiBtn" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Test API</button>
            </div>
        </div>
        
        <div class="mt-6 space-y-2">
            <button id="clearAuthBtn" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">Clear All Auth Data</button>
            <a href="/pages/login.html" class="block w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 text-center">Go to Login</a>
            <a href="/pages/technician/technician.html" class="block w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 text-center">Go to Technician Page</a>
        </div>
    </div>

    <script>
        function checkAuthentication() {
            // Check token
            const token = localStorage.getItem('token');
            const tokenStatus = document.getElementById('tokenStatus');
            
            if (token) {
                tokenStatus.innerHTML = `<span class="text-green-600">✓ Token found</span><br><span class="text-xs text-gray-500">${token.substring(0, 50)}...</span>`;
                
                // Decode token
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    const payload = JSON.parse(jsonPayload);
                    document.getElementById('tokenPayload').textContent = JSON.stringify(payload, null, 2);
                } catch (error) {
                    document.getElementById('tokenPayload').textContent = 'Error decoding token: ' + error.message;
                }
            } else {
                tokenStatus.innerHTML = '<span class="text-red-600">✗ No token found</span>';
                document.getElementById('tokenPayload').textContent = 'No token to decode';
            }
            
            // Check user data
            const userData = localStorage.getItem('user');
            const userDataElement = document.getElementById('userData');
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    userDataElement.textContent = JSON.stringify(user, null, 2);
                } catch (error) {
                    userDataElement.textContent = 'Error parsing user data: ' + error.message;
                }
            } else {
                userDataElement.textContent = 'No user data found';
            }
        }
        
        async function testAPI() {
            const apiTest = document.getElementById('apiTest');
            const token = localStorage.getItem('token');
            
            if (!token) {
                apiTest.innerHTML = '<span class="text-red-600">No token available for API test</span>';
                return;
            }
            
            try {
                apiTest.innerHTML = '<span class="text-yellow-600">Testing API...</span>';
                
                const response = await fetch('/api/technician/service-requests', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    apiTest.innerHTML = `<span class="text-green-600">✓ API works! Found ${data.length} service requests</span>`;
                } else {
                    apiTest.innerHTML = `<span class="text-red-600">✗ API failed: ${response.status} ${response.statusText}</span>`;
                }
            } catch (error) {
                apiTest.innerHTML = `<span class="text-red-600">✗ API error: ${error.message}</span>`;
            }
        }
        
        function clearAuth() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            
            document.getElementById('testApiBtn').addEventListener('click', testAPI);
            document.getElementById('clearAuthBtn').addEventListener('click', clearAuth);
        });
    </script>
</body>
</html>